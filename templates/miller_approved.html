<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Approved Orders | Miller</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
body{
  background:#f4f7f6;
  font-family:Inter,Segoe UI,sans-serif;
}

/* NAVBAR */
.navbar{
  background:linear-gradient(90deg,#1e6f5c,#145a48);
}
.navbar-brand{font-weight:900}

/* SECTION */
.section-card{
  background:#fff;
  border-radius:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
  padding:20px;
}

/* FOOTER */
.footer{
  background:#0b1c2d;
  color:#cfd6df;
  padding:20px;
  margin-top:40px;
  text-align:center;
  font-size:.85rem;
}
</style>
</head>

<body>

<!-- ================= NAVBAR ================= -->
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand" href="/miller">
      <i class="fa fa-industry"></i> Miller Dashboard
    </a>
    <a href="/miller" class="btn btn-sm btn-light">
      <i class="fa fa-arrow-left"></i> Back
    </a>
  </div>
</nav>

<div class="container my-4">

<!-- ================= DATA SPLIT ================= -->
{% set approved_loading = [] %}
{% for b in approved %}
  {% if b[7] < b[3] and b[8] != 'partial_closed' %}
    {% set _ = approved_loading.append(b) %}
  {% endif %}
{% endfor %}

<!-- ================= APPROVED LOADING ================= -->
<div class="section-card" id="approved-loading">
  <h6 class="fw-bold mb-3">
    <i class="fa fa-check-circle text-success"></i>
    Approved Orders (Still Loading)
  </h6>

  {% if approved_loading %}
  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Order ID</th>
          <th>Buyer</th>
          <th>Crop</th>
          <th>Booked</th>
          <th>Loaded</th>
          <th>Remaining</th>
          <th>Invoices</th>
          <th>Close Reason</th>
        </tr>
      </thead>

      <tbody>
      {% for b in approved_loading %}
      {% set booking_id = b[0] %}
      {% set booked = b[3] %}
      {% set loaded = b[7] %}
      {% set remaining = booked - loaded %}

      <tr>
        <td><strong class="text-primary">{{ b[10] }}</strong></td>
        <td>{{ b[1] }}</td>
        <td class="text-capitalize">{{ b[2] }}</td>

        <td><span class="badge bg-primary">{{ booked }} Qt</span></td>
        <td><span class="badge bg-success">{{ loaded }} Qt</span></td>
        <td><span class="badge bg-warning text-dark">{{ remaining }} Qt</span></td>

        <!-- Invoices -->
        <td>
          {% if invoices_map.get(booking_id) %}
            {% for inv in invoices_map[booking_id] %}
              <div class="mb-1">
                <span class="badge bg-info">{{ inv.qty }} Qt</span>
                <a href="/static/uploads/bills/{{ inv.file }}"
                   target="_blank"
                   class="btn btn-sm btn-outline-primary ms-1">
                   <i class="fa fa-file-invoice"></i>
                </a>
                <small class="text-muted d-block">{{ inv.date[:16] }}</small>
              </div>
            {% endfor %}
          {% else %}
            <span class="text-muted small">No loading yet</span>
          {% endif %}
        </td>

        <!-- Close Reason -->
        <td>
          {% if b[8] == 'partial_closed' and b[9] %}
            <span class="badge bg-warning text-dark">
              <i class="fa fa-lock"></i> Closed
            </span>
            <div class="small text-muted mt-1">{{ b[9] }}</div>
          {% else %}
            <span class="text-muted small">—</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <p class="text-muted mb-0">No orders currently loading.</p>
  {% endif %}
</div>
</div>

<!-- ================= FOOTER ================= -->
<footer class="footer">
  © 2026 <b>Sarna Mandi</b> · Approved Orders
</footer>

</body>
</html>

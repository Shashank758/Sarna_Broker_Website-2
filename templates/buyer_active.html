<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Active Orders | Sarna Mandi</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/static/css/style.css">

<style>
  body{
    background: var(--bg);
    min-height:100vh;
    display:flex;
    flex-direction:column;
  }

/* CARD */
.order-card{
  background:#fff;
  border-radius:18px;
  border:1px solid #e6e9ef;
  box-shadow:0 10px 28px rgba(0,0,0,.08);
  margin-bottom:18px;
  overflow:hidden;
}
.order-header{
  padding:16px 22px;
  background:#f8f9fb;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
}
.order-header:hover{background:#eef2f7}
.order-id{font-weight:900;font-size:1.05rem}
.order-sub{font-size:.85rem;color:#6c757d}

.badge-active{
  background:#0d6efd;
  color:#fff;
  padding:6px 14px;
  border-radius:20px;
  font-weight:800;
  font-size:.75rem;
}

/* BODY */
.order-body{padding:22px}
.section-title{
  font-weight:900;
  font-size:.8rem;
  text-transform:uppercase;
  margin-bottom:10px;
}
.kv{
  display:flex;
  justify-content:space-between;
  background:#f8f9fa;
  padding:10px 14px;
  border-radius:10px;
  margin-bottom:10px;
  font-weight:600;
}
.invoice-item{
  display:flex;
  justify-content:space-between;
  background:#fff;
  border:1px solid #eee;
  padding:10px 14px;
  border-radius:10px;
  margin-bottom:8px;
}

/* UPDATE BAR */
.update-bar{
  background:#ffffff;
  border:1px solid #e6e9ef;
  padding:14px;
  border-radius:14px;
  margin-top:18px;
}
.update-btn{
  background:linear-gradient(135deg,#198754,#157347);
  border:none;
  color:#fff;
  font-weight:900;
  border-radius:14px;
  padding:12px 18px;
}

/* PAGINATION */
.pagination .page-link{
  border-radius:10px;
  font-weight:700;
}

/* FOOTER */
.footer{
  background:#0b1c2d;
  color:#cfd6df;
  padding:40px 0 20px;
  margin-top:auto;
}

.footer-bottom{
  border-top:1px solid rgba(255,255,255,.1);
  margin-top:20px;
  padding-top:15px;
  font-size:.85rem;
  text-align:center;
}
</style>
</head>

<body>

<!-- NAVBAR -->
{% include '_navbar.html' %}

<main class="flex-fill">
<div class="container mt-4 mb-5">


<h4 class="fw-bold mb-4">
  <i class="fa fa-truck-moving text-primary"></i> Active Orders
</h4>

{% set per_page = 5 %}
{% set page = request.args.get('page', 1, type=int) %}
{% set total = orders|length %}
{% set pages = (total // per_page) + (1 if total % per_page else 0) %}
{% set start = (page - 1) * per_page %}
{% set end = start + per_page %}

{% if orders %}
{% for o in orders[start:end] %}

<div class="order-card">

  <!-- HEADER -->
  <div class="order-header"
       data-bs-toggle="collapse"
       data-bs-target="#order{{ o.id }}">
    <div>
      <div class="order-id">{{ o.order_id }}</div>
      <div class="order-sub">{{ o.crop }} ¬∑ {{ o.booked }} Qt</div>
      <div class="order-sub">Miller: {{ o.miller_name }}</div>
    </div>
    <span class="badge-active">ACTIVE</span>
  </div>

  <!-- BODY -->
  <div id="order{{ o.id }}" class="collapse">
    <div class="order-body">

      <div class="row g-4">
        <div class="col-md-6">
          <div class="section-title">Order Summary</div>
          <div class="kv"><span>Booked</span><span>{{ o.booked }} Qt</span></div>
          <div class="kv"><span>Loaded</span><span>{{ o.loaded }} Qt</span></div>
          <div class="kv"><span>Date</span><span>{{ o.loaded_at or '-' }}</span></div>
        </div>

        <div class="col-md-6">
          <div class="section-title">Truck Quality Checks</div>
          {% if o.invoices %}
            {% for inv in o.invoices %}
              <div class="mb-3 p-2 border rounded" style="background:#f8f9fa;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div>
                    <strong class="text-primary">
                      {% if inv.truck_number %}
                        Truck {{ inv.truck_number }}
                      {% else %}
                        Truck #{{ loop.index }}
                      {% endif %}
                    </strong>
                    <span class="badge bg-info ms-2">{{ inv.qty }} Qt</span>
                  </div>
                  {% if inv.qc_status == 'verified' %}
                    <span class="badge bg-success">‚úÖ Verified</span>
                  {% else %}
                    <span class="badge bg-warning">‚è≥ Pending QC</span>
                  {% endif %}
                </div>
                
                {% if inv.qc_status == 'verified' %}
                  <div class="kv"><span>Net Weight</span><span>{{ inv.qc_weight or inv.qty }} Qt</span></div>
                  <div class="kv"><span>Moisture</span><span>{{ inv.qc_moisture or '-' }}%</span></div>
                  {% if inv.qc_remarks %}
                  <div class="kv"><span>Remarks</span><span>{{ inv.qc_remarks }}</span></div>
                  {% endif %}
                  {% if inv.qc_at %}
                  <small class="text-muted d-block mt-2">Verified on {{ inv.qc_at[:16] }}</small>
                  {% endif %}
                {% else %}
                  <span class="text-muted small">Waiting for miller QC verification</span>
                {% endif %}
              </div>
            {% endfor %}
          {% else %}
            <span class="text-muted">No loading invoices found</span>
          {% endif %}
        </div>

        <div class="col-12">
          <div class="section-title">Loading Invoices</div>
          {% if o.invoices %}
            {% for inv in o.invoices %}
            <div class="invoice-item">
              <span>
                {% if inv.truck_number %}
                  <strong>{{ inv.truck_number }}</strong> ‚Äì {{ inv.qty }} Qt
                {% else %}
                  Truck #{{ loop.index }} ‚Äì {{ inv.qty }} Qt
                {% endif %}
              </span>
              <div class="d-flex gap-1">
                <a href="/static/uploads/bills/{{ inv.file }}" target="_blank" class="btn btn-sm btn-outline-primary">
                  <i class="fa fa-eye"></i> View
                </a>
                <button class="btn btn-sm btn-warning"
                        data-bs-toggle="modal"
                        data-bs-target="#editInvoice{{ inv.id }}">
                  <i class="fa fa-edit"></i> Edit
                </button>
                
                <!-- Edit Invoice Modal -->
                <div class="modal fade" id="editInvoice{{ inv.id }}" tabindex="-1">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">Edit Loading Invoice</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <form method="POST"
                            action="/buyer/edit_loading_invoice/{{ inv.id }}"
                            enctype="multipart/form-data">
                        <div class="modal-body">
                          <div class="mb-3">
                            <label class="form-label">Truck Number</label>
                            <input type="text"
                                   name="truck_number"
                                   class="form-control"
                                   value="{{ inv.truck_number or '' }}"
                                   placeholder="e.g. MH12AB1234">
                          </div>
                          <div class="mb-3">
                            <label class="form-label">Upload New Invoice</label>
                            <input type="file"
                                   name="invoice"
                                   class="form-control"
                                   accept=".pdf,image/*"
                                   required>
                            <small class="text-muted">This will replace the existing invoice for {{ inv.qty }} Qt.</small>
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <button type="submit" class="btn btn-warning">
                            <i class="fa fa-upload"></i> Replace Invoice
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <span class="text-muted">No invoices uploaded</span>
          {% endif %}
        </div>

        <!-- Payment Status (if fully loaded) -->
        {% if o.loaded >= o.booked %}
        <div class="col-12">
          <div class="section-title">Payment Status</div>
          {% if o.payment_status == 'paid' and o.final_invoice %}
            <div class="kv">
              <span>Status</span>
              <span class="badge bg-success">‚úÖ Payment Completed</span>
            </div>
            <a href="/static/uploads/bills/{{ o.final_invoice }}"
               target="_blank"
               class="btn btn-success btn-sm w-100 mt-2">
              <i class="fa fa-file-invoice"></i> View Final Invoice
            </a>
            {% if o.payment_at %}
            <small class="text-muted d-block text-center mt-2">
              Paid on {{ o.payment_at[:16] }}
            </small>
            {% endif %}
          {% elif o.final_invoice and o.payment_status != 'paid' %}
            <div class="kv">
              <span>Status</span>
              <span class="badge bg-warning">üí∞ Final Invoice Uploaded - Payment Pending</span>
            </div>
            <a href="/static/uploads/bills/{{ o.final_invoice }}"
               target="_blank"
               class="btn btn-outline-primary btn-sm w-100 mt-2">
              <i class="fa fa-eye"></i> View Final Invoice
            </a>
            <p class="text-muted small text-center mt-2 mb-0">
              Waiting for miller to mark payment done
            </p>
          {% else %}
            <div class="kv">
              <span>Status</span>
              <span class="badge bg-secondary">‚è≥ Waiting for Final Invoice</span>
            </div>
            <p class="text-muted small text-center mt-2 mb-0">
              Waiting for miller to upload final invoice
            </p>
          {% endif %}
        </div>
        {% endif %}

        <!-- üî• UPDATE LOADING BAR (ADDED) -->
        {% if o.loaded < o.booked %}
        <div class="col-12">
          <!-- Close Remaining Button -->
          <button class="btn btn-warning btn-sm w-100 mb-3"
                  data-bs-toggle="modal"
                  data-bs-target="#closeRemainingModal{{ o.id }}">
            <i class="fa fa-lock me-1"></i> Close Remaining Qty
          </button>
          
          <!-- Close Remaining Modal -->
          <div class="modal fade" id="closeRemainingModal{{ o.id }}" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">
                    <i class="fa fa-lock me-2"></i>Close Remaining Quantity
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/buyer/close_remaining/{{ o.id }}">
                  <div class="modal-body">
                    <div class="alert alert-warning">
                      <i class="fa fa-exclamation-triangle me-2"></i>
                      <strong>Warning:</strong> This will close the order with {{ o.booked - o.loaded }} Qt remaining unloaded.
                    </div>
                    <div class="mb-3">
                      <label class="form-label fw-bold">Reason for Closure <span class="text-danger">*</span></label>
                      <textarea name="reason"
                                class="form-control"
                                rows="3"
                                placeholder="Please provide a reason for closing the remaining quantity..."
                                required></textarea>
                      <small class="text-muted">This information will be shared with the miller.</small>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                      <i class="fa fa-times me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-warning">
                      <i class="fa fa-lock me-1"></i>Close Remaining Qty
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          
          <form method="POST"
                action="/buyer/update_loading/{{ o.id }}"
                enctype="multipart/form-data"
                class="update-bar row g-2 align-items-center">

            <div class="col-md-3">
              <input type="number"
                     name="load_qty"
                     class="form-control"
                     min="1"
                     max="{{ o.booked - o.loaded }}"
                     placeholder="Qty to load"
                     required>
            </div>

            <div class="col-md-3">
              <input type="text"
                     name="truck_number"
                     class="form-control"
                     placeholder="Truck number"
                     required>
            </div>

            <div class="col-md-4">
              <input type="file"
                     name="invoice"
                     class="form-control"
                     required>
            </div>

            <div class="col-md-2 d-grid">
              <button class="update-btn">
                <i class="fa fa-truck"></i> Update
              </button>
            </div>

          </form>
        </div>
        {% endif %}

      </div>

    </div>
  </div>
</div>

{% endfor %}
{% else %}
<p class="text-muted">No active orders</p>
{% endif %}

<!-- PAGINATION -->
{% if pages > 1 %}
<nav class="mt-4">
  <ul class="pagination justify-content-center">
    {% for p in range(1, pages+1) %}
    <li class="page-item {% if p==page %}active{% endif %}">
      <a class="page-link" href="?page={{ p }}">{{ p }}</a>
    </li>
    {% endfor %}
  </ul>
</nav>
{% endif %}

</div>
</main>
<!-- FOOTER -->
{% include '_footer.html' %}


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

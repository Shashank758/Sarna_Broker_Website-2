<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard | Sarna Broker</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="/static/css/style.css">
</head>

<body>

<!-- ================= TOP NAVBAR ================= -->
<nav class="admin-navbar">
  <div class="nav-left">
    <img src="static/image/Sarna broker.png" alt="Logo">
    <span>Sarna Broker</span>
  </div>

  <center><b>JAI SHREE SHYAM</b></center>

  <div class="nav-right">
    <span class="admin-name">
      <i class="fa fa-user-circle"></i> Admin
    </span>
    <img src="static/image/images.png" alt="Logo">
  </div>
</nav>

<div class="admin-container">

  <!-- SIDEBAR -->
  <aside class="admin-sidebar">
    <h4>Sarna Broker</h4>
    <ul>
      <li class="active"><a href="/admin"><i class="fa fa-gauge"></i> Dashboard</a></li>
      <li><a href="/admin/compare"><i class="fa fa-balance-scale"></i> Rate Comparison</a></li>
      <li><a href="/admin/users"><i class="fa fa-users"></i> Users</a></li>
      <li><a href="/admin/stock"><i class="fa fa-box"></i> Miller Stock</a></li>
      <li><a href="/admin/stock-history"><i class="fa fa-history"></i> Stock Update History</a></li>
      <li><a href="/admin/bookings"><i class="fa fa-shopping-cart"></i> Bookings</a></li>
      <li><a href="/admin/miller-profiles"><i class="fa fa-industry"></i> Miller Profiles</a></li>
      <li><a href="/admin/buyer-profiles"><i class="fa fa-store"></i> Buyer Profiles</a></li>
      <li>
        <i class="fa fa-right-from-bracket"></i>
        <a href="/logout">Logout</a>
      </li>
    </ul>
  </aside>

  <!-- MAIN -->
  <main class="admin-main">

    <div class="admin-top">
      <h5>Admin Dashboard</h5>
      <span class="admin-badge">Admin</span>
    </div>

    <!-- ================= STATS ================= -->
    <div class="row mt-3">
      <div class="col-md-3">
        <div class="stat-card">
          <i class="fa fa-user"></i>
          <div>
            <h6>Farmers</h6>
            <p>{{ farmer_count }}</p>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="stat-card">
          <i class="fa fa-cart-shopping"></i>
          <div>
            <h6>Traders</h6>
            <p>{{ buyer_count }}</p>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="stat-card">
          <i class="fa fa-industry"></i>
          <div>
            <h6>Millers</h6>
            <p>{{ miller_count }}</p>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="stat-card">
          <i class="fa fa-shopping-cart"></i>
          <div>
            <h6>Total Bookings</h6>
            <p>{{ total_bookings }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ================= ADDITIONAL STATS ================= -->
    <div class="row mt-3">
      <div class="col-md-3">
        <div class="stat-card">
          <i class="fa fa-check-circle text-success"></i>
          <div>
            <h6>Approved Bookings</h6>
            <p>{{ approved_bookings }}</p>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="stat-card">
          <i class="fa fa-clock text-warning"></i>
          <div>
            <h6>Pending Bookings</h6>
            <p>{{ pending_bookings }}</p>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="stat-card">
          <i class="fa fa-rupee-sign text-success"></i>
          <div>
            <h6>Total Revenue</h6>
            <p>â‚¹{{ "{:,}".format(total_revenue) }}</p>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="stat-card">
          <i class="fa fa-box text-info"></i>
          <div>
            <h6>Total Stock</h6>
            <p>{{ total_stock_qty }} Qt</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ================= CHARTS ================= -->
    <!-- ================= CHARTS ================= -->
    <div class="row mt-4">
      <!-- Booking Status Chart -->
      <div class="col-md-6 mb-4">
        <div class="table-card">
          <h6>ðŸ“Š Booking Status Distribution</h6>
          <canvas id="bookingStatusChart" style="max-height: 300px;"></canvas>
        </div>
      </div>

      <!-- User Status Chart -->
      <div class="col-md-6 mb-4">
        <div class="table-card">
          <h6>ðŸ‘¥ User Status Distribution</h6>
          <canvas id="userStatusChart" style="max-height: 300px;"></canvas>
        </div>
      </div>
    </div>

    <div class="row mt-4">
      <!-- Stock by Crop Chart -->
      <div class="col-md-6 mb-4">
        <div class="table-card">
          <h6>ðŸŒ¾ Stock Quantity by Crop</h6>
          <canvas id="stockByCropChart" style="max-height: 300px;"></canvas>
        </div>
      </div>

      <!-- Recent Bookings Trend -->
      <div class="col-md-6 mb-4">
        <div class="table-card">
          <h6>ðŸ“ˆ Recent Bookings (Last 7 Days)</h6>
          <canvas id="recentBookingsChart" style="max-height: 300px;"></canvas>
        </div>
      </div>
    </div>

  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  // Booking Status Chart
  const bookingStatusCtx = document.getElementById('bookingStatusChart').getContext('2d');
  new Chart(bookingStatusCtx, {
    type: 'doughnut',
    data: {
      labels: ['Pending', 'Approved', 'Declined'],
      datasets: [{
        data: [{{ pending_bookings }}, {{ approved_bookings }}, {{ declined_bookings }}],
        backgroundColor: ['#ffc107', '#28a745', '#dc3545'],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });

  // User Status Chart
  const userStatusCtx = document.getElementById('userStatusChart').getContext('2d');
  new Chart(userStatusCtx, {
    type: 'pie',
    data: {
      labels: ['Approved', 'Pending', 'Blocked'],
      datasets: [{
        data: [{{ approved_users }}, {{ pending_users }}, {{ blocked_users }}],
        backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });

  // Stock by Crop Chart
  const stockByCropCtx = document.getElementById('stockByCropChart').getContext('2d');
  const cropLabels = [{% if crop_stats and crop_stats|length > 0 %}{% for crop, data in crop_stats.items() %}'{{ crop }}'{% if not loop.last %},{% endif %}{% endfor %}{% else %}[]{% endif %}];
  const cropQuantities = [{% if crop_stats and crop_stats|length > 0 %}{% for crop, data in crop_stats.items() %}{{ data.quantity }}{% if not loop.last %},{% endif %}{% endfor %}{% else %}[]{% endif %}];
  
  {% if crop_stats and crop_stats|length > 0 %}
  new Chart(stockByCropCtx, {
    type: 'bar',
    data: {
      labels: cropLabels,
      datasets: [{
        label: 'Quantity (Quintal)',
        data: cropQuantities,
        backgroundColor: '#1e7e34',
        borderColor: '#155d27',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return value + ' Qt';
            }
          }
        }
      },
      plugins: {
        legend: {
          display: false
        }
      }
    }
  });
  {% else %}
  // No crop data available
  new Chart(stockByCropCtx, {
    type: 'bar',
    data: {
      labels: ['No Data'],
      datasets: [{
        data: [0],
        backgroundColor: '#e0e0e0'
      }]
    }
  });
  {% endif %}

  // Recent Bookings Trend
  const recentBookingsCtx = document.getElementById('recentBookingsChart').getContext('2d');
  const bookingDates = [{% if recent_bookings_dates and recent_bookings_dates|length > 0 %}{% for date in recent_bookings_dates %}'{{ date }}'{% if not loop.last %},{% endif %}{% endfor %}{% else %}[]{% endif %}];
  const bookingCounts = [{% if recent_bookings_counts and recent_bookings_counts|length > 0 %}{% for count in recent_bookings_counts %}{{ count }}{% if not loop.last %},{% endif %}{% endfor %}{% else %}[]{% endif %}];
  
  {% if recent_bookings_dates and recent_bookings_dates|length > 0 %}
  new Chart(recentBookingsCtx, {
    type: 'line',
    data: {
      labels: bookingDates,
      datasets: [{
        label: 'Bookings',
        data: bookingCounts,
        borderColor: '#1e7e34',
        backgroundColor: 'rgba(30, 126, 52, 0.1)',
        borderWidth: 2,
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      },
      plugins: {
        legend: {
          display: false
        }
      }
    }
  });
  {% else %}
  // No recent bookings data
  new Chart(recentBookingsCtx, {
    type: 'line',
    data: {
      labels: ['No Data'],
      datasets: [{
        data: [0],
        borderColor: '#e0e0e0'
      }]
    }
  });
  {% endif %}
</script>

</body>
</html>

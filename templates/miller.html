<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Miller Dashboard | Saarna Canvessars</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<link rel="stylesheet" href="/static/css/style.css">

<style>
:root{
  --primary:#0f9b5f;
  --primary-dark:#0d8a54;
  --primary-darker:#0a7548;
  --primary-light:#12b36e;
  --bg-light:#f4f7f6;
  --card-bg:#ffffff;
  --text-primary:#1e293b;
  --text-muted:#64748b;
  --border-color:#e2e8f0;
  --success:#10b981;
  --warning:#f59e0b;
  --danger:#ef4444;
  --info:#3b82f6;
  --radius:16px;
  --shadow-sm:0 1px 2px rgba(0,0,0,.05);
  --shadow-md:0 4px 15px rgba(0,0,0,.08);
  --shadow-lg:0 10px 40px rgba(0,0,0,.12);
}

/* ========== GLOBAL ========== */
body{
  background:var(--bg-light);
  font-family:'Segoe UI','Inter',sans-serif;
  color:var(--text-primary);
  line-height:1.6;
  min-height:100vh;
  display:flex;
  flex-direction:column;
}

main{
  flex:1;
}

/* ========== HERO DASHBOARD HEADER ========== */
.dashboard-hero{
  background:linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 50%, var(--primary-darker) 100%);
  color:#fff;
  padding:40px 0;
  position:relative;
  overflow:hidden;
}
.dashboard-hero::before{
  content:'';
  position:absolute;
  top:-100px;
  right:-100px;
  width:400px;
  height:400px;
  background:radial-gradient(circle,rgba(255,255,255,0.1) 0%,transparent 70%);
  pointer-events:none;
}
.dashboard-hero::after{
  content:'';
  position:absolute;
  bottom:-50px;
  left:-50px;
  width:200px;
  height:200px;
  background:radial-gradient(circle,rgba(255,255,255,0.08) 0%,transparent 70%);
  pointer-events:none;
}
.dashboard-hero h1{
  font-weight:800;
  font-size:2rem;
  margin-bottom:8px;
}
.dashboard-hero p{
  opacity:0.9;
  font-size:1rem;
  margin:0;
}

/* ========== STAT CARDS ========== */
.stat-card{
  background:#fff;
  border-radius:var(--radius);
  padding:24px;
  box-shadow:var(--shadow-md);
  border:1px solid rgba(0,0,0,.05);
  transition:all 0.3s ease;
  position:relative;
  overflow:hidden;
}
.stat-card:hover{
  transform:translateY(-5px);
  box-shadow:var(--shadow-lg);
}
.stat-card .stat-icon{
  width:56px;
  height:56px;
  border-radius:14px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:24px;
  color:#fff;
}
.stat-card .stat-icon.stocks{background:linear-gradient(135deg,var(--primary),var(--primary-dark));}
.stat-card .stat-icon.pending{background:linear-gradient(135deg,var(--warning),#d97706);}
.stat-card .stat-icon.approved{background:linear-gradient(135deg,var(--success),#059669);}
.stat-card .stat-icon.completed{background:linear-gradient(135deg,var(--info),#2563eb);}
.stat-card .stat-value{
  font-size:2rem;
  font-weight:800;
  color:var(--text-primary);
  line-height:1;
}
.stat-card .stat-label{
  font-size:0.85rem;
  color:var(--text-muted);
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:0.5px;
}
.stat-card::before{
  content:'';
  position:absolute;
  top:0;
  left:0;
  width:4px;
  height:100%;
  border-radius:var(--radius) 0 0 var(--radius);
}
.stat-card.stocks::before{background:var(--primary);}
.stat-card.pending::before{background:var(--warning);}
.stat-card.approved::before{background:var(--success);}
.stat-card.completed::before{background:var(--info);}

/* ========== QUICK ACTIONS ========== */
.quick-actions{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  margin-top:20px;
}
.quick-action-btn{
  background:rgba(255,255,255,0.15);
  border:1px solid rgba(255,255,255,0.3);
  color:#fff;
  padding:10px 20px;
  border-radius:10px;
  font-weight:600;
  font-size:0.9rem;
  transition:all 0.3s ease;
  text-decoration:none;
  display:inline-flex;
  align-items:center;
  gap:8px;
}
.quick-action-btn:hover{
  background:rgba(255,255,255,0.25);
  color:#fff;
  transform:translateY(-2px);
}

/* ========== SECTION CARDS ========== */
.section-card{
  background:var(--card-bg);
  border-radius:var(--radius);
  padding:28px;
  margin-bottom:28px;
  box-shadow:var(--shadow-md);
  border:1px solid rgba(0,0,0,.05);
}

.section-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:24px;
  padding-bottom:16px;
  border-bottom:2px solid var(--border-color);
}
.section-title{
  font-weight:700;
  font-size:1.15rem;
  display:flex;
  align-items:center;
  gap:12px;
  color:var(--text-primary);
  margin:0;
}
.section-title .icon-box{
  width:40px;
  height:40px;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
}
.section-title .icon-box.green{background:rgba(15,155,95,0.1);color:var(--primary);}
.section-title .icon-box.yellow{background:rgba(245,158,11,0.1);color:var(--warning);}
.section-title .icon-box.blue{background:rgba(59,130,246,0.1);color:var(--info);}
.section-title .icon-box.red{background:rgba(239,68,68,0.1);color:var(--danger);}

.section-badge{
  font-size:0.85rem;
  padding:8px 16px;
  border-radius:30px;
  font-weight:600;
}

/* ========== FORM STYLING ========== */
.form-group{
  margin-bottom:20px;
}
.form-label{
  font-weight:600;
  color:var(--text-primary);
  margin-bottom:8px;
  font-size:0.9rem;
}
.form-control,.form-select{
  border-radius:10px;
  padding:12px 16px;
  border:2px solid var(--border-color);
  font-size:0.95rem;
  transition:all 0.3s ease;
}
.form-control:focus,.form-select:focus{
  border-color:var(--primary);
  box-shadow:0 0 0 4px rgba(15,155,95,0.15);
}
.form-control-sm{
  padding:8px 12px;
  font-size:0.85rem;
}

/* ========== BUTTONS ========== */
.btn-primary-custom{
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  color:#fff;
  border:none;
  font-weight:600;
  border-radius:10px;
  padding:14px 28px;
  font-size:1rem;
  transition:all 0.3s ease;
}
.btn-primary-custom:hover{
  background:linear-gradient(135deg,var(--primary-dark),var(--primary-darker));
  color:#fff;
  transform:translateY(-2px);
  box-shadow:0 8px 25px rgba(15,155,95,0.3);
}

/* ========== TABLE STYLING ========== */
.table-modern{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
}
.table-modern thead th{
  background:linear-gradient(135deg,#f8fafc,#f1f5f9);
  padding:16px 14px;
  font-size:0.8rem;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:0.5px;
  color:var(--text-muted);
  border-bottom:2px solid var(--primary);
  text-align:center;
}
.table-modern tbody td{
  padding:16px 14px;
  text-align:center;
  vertical-align:middle;
  border-bottom:1px solid var(--border-color);
  font-size:0.9rem;
}
.table-modern tbody tr{
  transition:all 0.2s ease;
}
.table-modern tbody tr:hover{
  background:rgba(15,155,95,0.03);
}

/* ========== ORDER CARDS ========== */
.order-card{
  background:#fff;
  border-radius:14px;
  border:1px solid rgba(0,0,0,.08);
  padding:20px;
  transition:all 0.3s ease;
  height:100%;
}
.order-card:hover{
  transform:translateY(-5px);
  box-shadow:var(--shadow-lg);
  border-color:var(--primary);
}
.order-card .order-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:16px;
}
.order-card .order-id{
  font-weight:700;
  color:var(--primary);
  font-size:1rem;
}
.order-card .order-meta{
  color:var(--text-muted);
  font-size:0.85rem;
}
.order-card .order-badges{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin:12px 0;
}

/* ========== TRUCK QC ITEM ========== */
.truck-qc-item{
  background:linear-gradient(135deg,#f8fafc,#fff);
  border:1px solid var(--border-color);
  border-radius:12px;
  padding:16px;
  margin-bottom:12px;
  transition:all 0.2s ease;
}
.truck-qc-item:hover{
  border-color:var(--primary);
  box-shadow:0 4px 15px rgba(15,155,95,0.1);
}

/* ========== FILTER BAR ========== */
.filter-bar{
  background:linear-gradient(135deg,#f8fafc,#fff);
  border:1px solid var(--border-color);
  border-radius:14px;
  padding:20px;
  margin-bottom:24px;
}
.filter-pill{
  padding:8px 18px;
  border-radius:25px;
  font-weight:600;
  font-size:0.85rem;
  border:2px solid var(--border-color);
  background:#fff;
  color:var(--text-muted);
  cursor:pointer;
  transition:all 0.2s ease;
}
.filter-pill:hover{
  border-color:var(--primary);
  color:var(--primary);
}
.filter-pill.active{
  background:var(--primary);
  color:#fff;
  border-color:var(--primary);
}

/* ========== SCROLL CONTAINER ========== */
.scroll-container{
  max-height:70vh;
  overflow-y:auto;
  padding-right:10px;
}
.scroll-container::-webkit-scrollbar{
  width:8px;
}
.scroll-container::-webkit-scrollbar-thumb{
  background:var(--primary);
  border-radius:10px;
}
.scroll-container::-webkit-scrollbar-track{
  background:#f1f5f9;
  border-radius:10px;
}

/* ========== EMPTY STATE ========== */
.empty-state{
  text-align:center;
  padding:40px 20px;
}
.empty-state i{
  font-size:48px;
  color:var(--border-color);
  margin-bottom:16px;
}
.empty-state p{
  color:var(--text-muted);
  margin:0;
}

/* ========== RESPONSIVE ========== */
@media(max-width:768px){
  .dashboard-hero h1{font-size:1.5rem;}
  .stat-card{padding:18px;}
  .stat-card .stat-value{font-size:1.5rem;}
  .quick-actions{justify-content:center;}
}

/* ========== SMOOTH SCROLL ========== */
html{
  scroll-behavior:smooth;
}
</style>
</head>

<body>

{% include '_navbar.html' %}

<!-- ================= DASHBOARD HERO ================= -->
<section class="dashboard-hero">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-lg-8" data-aos="fade-right">
        <h1><i class="fa fa-industry me-3"></i>Miller Trading Dashboard</h1>
        <p><i class="fa fa-chart-line me-2"></i>Manage your stock, approve orders, track quality & process payments ‚Äî all in one place</p>
        
        <div class="quick-actions">
          <a href="#post-stock" class="quick-action-btn">
            <i class="fa fa-plus-circle"></i> Post Stock
          </a>
          <a href="#pending-orders" class="quick-action-btn">
            <i class="fa fa-clock"></i> Pending Orders
          </a>
          <a href="#quality-check" class="quick-action-btn">
            <i class="fa fa-clipboard-check"></i> Quality Check
          </a>
          <a href="/miller/profile" class="quick-action-btn">
            <i class="fa fa-user-cog"></i> Profile
          </a>
        </div>
      </div>
    </div>
  </div>
</section>

<main>
<div class="container py-4" style="max-width:1200px;">

<!-- ================= QUICK STATS ================= -->
{% set total_stocks = stocks|length %}
{% set total_pending = pending|length %}
{% set total_approved = approved|length %}
{% set total_completed = completed_loading_qc|length if completed_loading_qc else 0 %}

<div class="row g-4 mb-4" style="margin-top:-60px;">
  <div class="col-md-6 col-lg-3" data-aos="fade-up" data-aos-delay="0">
    <div class="stat-card stocks">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="stat-label mb-2">Active Stocks</div>
          <div class="stat-value">{{ total_stocks }}</div>
        </div>
        <div class="stat-icon stocks">
          <i class="fa fa-warehouse"></i>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-6 col-lg-3" data-aos="fade-up" data-aos-delay="100">
    <div class="stat-card pending">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="stat-label mb-2">Pending Requests</div>
          <div class="stat-value">{{ total_pending }}</div>
        </div>
        <div class="stat-icon pending">
          <i class="fa fa-clock"></i>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-6 col-lg-3" data-aos="fade-up" data-aos-delay="200">
    <div class="stat-card approved">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="stat-label mb-2">Approved Orders</div>
          <div class="stat-value">{{ total_approved }}</div>
        </div>
        <div class="stat-icon approved">
          <i class="fa fa-check-circle"></i>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-6 col-lg-3" data-aos="fade-up" data-aos-delay="300">
    <div class="stat-card completed">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="stat-label mb-2">QC Pending</div>
          <div class="stat-value">{{ total_completed }}</div>
        </div>
        <div class="stat-icon completed">
          <i class="fa fa-truck"></i>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ================= POST STOCK ================= -->
<div class="section-card" id="post-stock" data-aos="fade-up">
  <div class="section-header">
    <h5 class="section-title">
      <span class="icon-box green"><i class="fa fa-plus-circle"></i></span>
      Post New Stock
    </h5>
  </div>

  <form method="POST">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label"><i class="fa fa-seedling me-2 text-success"></i>Crop Type</label>
        <select name="crop" class="form-select" required>
          <option value="">Select Crop</option>
          <option value="wheat">üåæ Wheat</option>
          <option value="chawal">üçö Chawal (Rice)</option>
          <option value="sarso">üåª Sarso (Mustard)</option>
          <option value="maize">üåΩ Maize</option>
          <option value="paddy">üåæ Paddy</option>
          <option value="mustard oil cake">üßà Mustard Oil Cake</option>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label"><i class="fa fa-weight-hanging me-2 text-info"></i>Quantity (Quintal)</label>
        <input type="number" name="quantity" class="form-control" min="1" step="0.01" placeholder="e.g. 100.5" required>
      </div>

      <div class="col-md-4">
        <label class="form-label"><i class="fa fa-indian-rupee-sign me-2 text-warning"></i>Price / Quintal</label>
        <input type="number" name="price" class="form-control" min="1" step="0.01" placeholder="e.g. 2500.50" required>
      </div>

      <div class="col-md-4">
        <label class="form-label"><i class="fa fa-scale-balanced me-2 text-secondary"></i>Condition</label>
        <select name="condition" class="form-select">
          <option value="Net">Net Weight</option>
          <option value="Full">Full Weight</option>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label"><i class="fa fa-box me-2 text-primary"></i>Bag Type</label>
        <select name="bag_type" class="form-select">
          <option value="Jute">Jute Bag</option>
          <option value="Plastic">Plastic Bag</option>
          <option value="Jute/Plastic">Jute / Plastic</option>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label"><i class="fa fa-minus-circle me-2 text-danger"></i>Deduction Note</label>
        <input type="text" name="deduction" placeholder="e.g. 2% moisture cut" class="form-control">
      </div>

      <div class="col-12 mt-3">
        <button class="btn btn-primary-custom w-100">
          <i class="fa fa-upload me-2"></i> Post Stock to Market
        </button>
      </div>
    </div>
  </form>
</div>

<!-- ================= LIVE STOCK ================= -->
<div class="section-card" data-aos="fade-up">
  <div class="section-header">
    <h5 class="section-title">
      <span class="icon-box green"><i class="fa fa-warehouse"></i></span>
      Your Live Stock
    </h5>
    <span class="section-badge bg-success">{{ stocks|length }} Active</span>
  </div>

  {% if stocks %}
  <div class="table-responsive">
    <table class="table-modern">
      <thead>
        <tr>
          <th>Crop</th>
          <th>Quantity</th>
          <th>Price/Qt</th>
          <th>Condition</th>
          <th>Bag Type</th>
          <th>Deduction</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for s in stocks %}
        <form method="POST" action="/update_miller_stock/{{ s[0] }}">
        <tr>
          <td>
            <span class="fw-bold text-capitalize">
              <i class="fa fa-seedling text-success me-2"></i>{{ s[2] }}
            </span>
          </td>
          <td>
            <input type="number" name="quantity" value="{{ s[3] }}" step="0.01" class="form-control form-control-sm" style="width:80px;margin:auto;">
          </td>
          <td>
            <input type="number" name="price" value="{{ s[4] }}" step="0.01" class="form-control form-control-sm" style="width:90px;margin:auto;">
          </td>
          <td>
            <select name="condition" class="form-select form-select-sm" style="width:90px;margin:auto;">
              <option {{ 'selected' if s[5]=='Net' }}>Net</option>
              <option {{ 'selected' if s[5]=='Full' }}>Full</option>
            </select>
          </td>
          <td>
            <select name="bag_type" class="form-select form-select-sm" style="width:110px;margin:auto;">
              <option {{ 'selected' if s[6]=='Jute' }}>Jute</option>
              <option {{ 'selected' if s[6]=='Plastic' }}>Plastic</option>
              <option {{ 'selected' if s[6]=='Jute/Plastic' }}>Jute/Plastic</option>
            </select>
          </td>
          <td>
            <input type="text" name="deduction" value="{{ s[7] }}" class="form-control form-control-sm" style="width:120px;margin:auto;">
          </td>
          <td>
            <button class="btn btn-sm btn-success">
              <i class="fa fa-save me-1"></i> Update
            </button>
          </td>
        </tr>
        </form>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="empty-state">
    <i class="fa fa-warehouse"></i>
    <p>No stock posted yet. Use the form above to add your first stock!</p>
  </div>
  {% endif %}
</div>

<!-- ================= ORDERS ================= -->
{% set pending = bookings | selectattr(4,'equalto','pending') | list %}
{% set approved = bookings | selectattr(4,'equalto','approved') | list %}
{% set rejected = bookings | selectattr(4,'equalto','declined') | list %}

<!-- ================= BOOKING FILTER ================= -->
<div class="filter-bar" data-aos="fade-up">
  <div class="row g-3 align-items-end">
    <div class="col-md-3">
      <label class="form-label"><i class="fa fa-filter me-2"></i>Filter Status</label>
      <select id="statusFilter" class="form-select">
        <option value="all">All Orders</option>
        <option value="pending">Pending</option>
        <option value="approved">Approved</option>
        <option value="declined">Rejected</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label"><i class="fa fa-user me-2"></i>Buyer Name</label>
      <input type="text" id="buyerFilter" class="form-control" placeholder="Search buyer...">
    </div>
    <div class="col-md-3">
      <label class="form-label"><i class="fa fa-seedling me-2"></i>Crop</label>
      <input type="text" id="cropFilter" class="form-control" placeholder="Search crop...">
    </div>
    <div class="col-md-3">
      <button onclick="clearFilters()" class="btn btn-outline-secondary w-100">
        <i class="fa fa-times me-2"></i>Clear Filters
      </button>
    </div>
  </div>
</div>

<!-- ================= PENDING ORDERS ================= -->
<div class="section-card" id="pending-orders" data-aos="fade-up">
  <div class="section-header">
    <h5 class="section-title">
      <span class="icon-box yellow"><i class="fa fa-clock"></i></span>
      Pending Order Requests
    </h5>
    <span class="section-badge bg-warning text-dark">{{ pending|length }} Pending</span>
  </div>

  {% if pending %}
  <div class="row g-3">
    {% for b in pending %}
    <div class="col-md-6 col-lg-4 booking-row" 
         data-status="pending" 
         data-buyer="{{ b[1]|lower }}" 
         data-crop="{{ b[2]|lower }}">
      <div class="order-card">
        <div class="order-header">
          <div>
            <div class="order-id">{{ b[10] if b[10] else 'N/A' }}</div>
            <div class="order-meta">{{ b[1] }} ‚Ä¢ <span class="text-capitalize">{{ b[2] }}</span></div>
          </div>
          <span class="badge bg-warning text-dark">
            <i class="fa fa-clock me-1"></i>Pending
          </span>
        </div>
        
        <div class="order-badges">
          <span class="badge bg-primary"><i class="fa fa-weight-hanging me-1"></i>{{ b[3] }} Quintal</span>
        </div>
        
        <div class="d-grid gap-2 mt-3">
          <a href="/miller/approve_booking/{{ b[0] }}" class="btn btn-success btn-sm">
            <i class="fa fa-check me-2"></i>Approve Order
          </a>
          
          <form method="POST" action="/miller/decline_booking/{{ b[0] }}">
            <input name="reason" class="form-control form-control-sm mb-2" placeholder="Rejection reason..." required>
            <button class="btn btn-outline-danger btn-sm w-100">
              <i class="fa fa-times me-2"></i>Reject
            </button>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="empty-state">
    <i class="fa fa-inbox"></i>
    <p>No pending orders at the moment. New requests will appear here.</p>
  </div>
  {% endif %}
</div>
<!-- APPROVED (Still Loading) -->
{% set approved_loading = [] %}
{% set completed_loading_qc = [] %}
{% set final_invoice_uploaded = [] %}
{% set payment_completed = [] %}
{% for b in approved %}
  {% set booked = b[3] %}
  {% set loaded = b[7] %}
  {% set payment_status = b[16] %}
  {% set final_invoice = b[17] %}
  {% if loaded < booked and b[8] != 'partial_closed' %}
    {% set _ = approved_loading.append(b) %}
  {% elif payment_status == 'paid' %}
    {% set _ = payment_completed.append(b) %}
  {% elif final_invoice and payment_status != 'paid' %}
    {% set _ = final_invoice_uploaded.append(b) %}
  {% else %}
    {% set _ = completed_loading_qc.append(b) %}
  {% endif %}
{% endfor %}

<div class="section-card" id="approved-loading" data-aos="fade-up">
  <div class="section-header">
    <h5 class="section-title">
      <span class="icon-box green"><i class="fa fa-check-circle"></i></span>
      Approved Orders (Still Loading)
    </h5>
    <span class="section-badge bg-success" id="approvedLoadingCount">{{ approved_loading|length }} Active</span>
  </div>

  <!-- Filter & Search (QC pending trucks) -->
  <div class="filter-bar mb-4">
    <div class="d-flex gap-2 flex-wrap align-items-center">
      <button type="button"
              class="btn btn-sm btn-success approved-loading-filter-btn"
              data-filter="all"
              onclick="filterApprovedLoading('all')">
        <i class="fa fa-list me-1"></i> All
      </button>
      <button type="button"
              class="btn btn-sm btn-outline-secondary approved-loading-filter-btn"
              data-filter="pending"
              onclick="filterApprovedLoading('pending')">
        <i class="fa fa-clock me-1"></i> QC Pending
      </button>
      <button type="button"
              class="btn btn-sm btn-outline-secondary approved-loading-filter-btn"
              data-filter="verified"
              onclick="filterApprovedLoading('verified')">
        <i class="fa fa-check-circle me-1"></i> QC Verified
      </button>

      <div class="flex-grow-1" style="min-width:260px;">
        <input type="text"
               id="approvedLoadingSearchInput"
               class="form-control"
               placeholder="üîç Search by Order ID, Buyer, Crop, Truck..."
               onkeyup="searchApprovedLoading()">
      </div>
    </div>
  </div>

  {% if approved_loading %}
  <div class="table-responsive">
  <table class="table-modern">
    <thead>
    <tr>
      <th>Order ID</th>
      <th>Buyer</th>
      <th>Crop</th>
      <th>Booked</th>
      <th>Loaded</th>
      <th>Remaining</th>
      <th>Invoices</th>
      <th>Status</th>
    </tr>
    </thead>
    <tbody>
  
    {% for b in approved_loading %}
    {% set booking_id = b[0] %}
    {% set booked = b[3] %}
    {% set loaded = b[7] %}
    {% set remaining = booked - loaded %}

    {% set invs = invoices_map.get(booking_id) %}
    {% set ns = namespace(pending=0, search=(b[10]|string + ' ' + b[1] + ' ' + b[2])|lower) %}
    {% if invs %}
      {% for inv in invs %}
        {% if inv.qc_status != 'verified' %}
          {% set ns.pending = ns.pending + 1 %}
        {% endif %}
        {% if inv.truck_number %}
          {% set ns.search = ns.search + ' ' + (inv.truck_number|string|lower) %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {% set qc_row_status = 'none' if not invs else ('pending' if ns.pending > 0 else 'verified') %}

    <tr class="approved-loading-row" data-qc="{{ qc_row_status }}" data-search="{{ ns.search }}">
      <td><strong class="text-primary">{{ b[10] }}</strong></td>
      <td>{{ b[1] }}</td>
      <td>{{ b[2] }}</td>
  
      <td><span class="badge bg-primary">{{ booked }} Qt</span></td>
  
      <td>
        <span class="badge bg-success">{{ loaded }} Qt</span>
      </td>
  
      <td>
        <span class="badge bg-warning">{{ remaining }} Qt</span>
      </td>

      <!-- QC Summary -->
      <td>
        {% if not invs %}
          <span class="badge bg-secondary">No Trucks</span>
        {% elif ns.pending > 0 %}
          <span class="badge bg-warning text-dark">QC Pending: {{ ns.pending }}</span>
        {% else %}
          <span class="badge bg-success">QC Verified</span>
        {% endif %}
      </td>
      
      <!-- üî¥ PER LOADING INVOICES + QC (for loaded trucks even if order still loading) -->
      <td>
        {% if invs %}
          <ul class="list-unstyled mb-0">
            {% for inv in invs %}
              <li class="mb-2 p-2 border rounded" style="background:#f8f9fa;">
                <div class="d-flex justify-content-between align-items-start gap-2">
                  <div>
                    <div class="fw-semibold">
                      {% if inv.truck_number %}
                        Truck {{ inv.truck_number }}
                      {% else %}
                        Truck #{{ loop.index }}
                      {% endif %}
                      <span class="badge bg-info ms-2">{{ inv.qty }} Qt</span>
                    </div>

                    <a href="/static/uploads/bills/{{ inv.file }}"
                       target="_blank"
                       class="btn btn-sm btn-outline-primary mt-1">
                      <i class="fa fa-file-invoice"></i> Invoice
                    </a>

                    <small class="text-muted d-block">{{ inv.date[:16] }}</small>
                  </div>

                  <div class="text-end">
                    {% if inv.qc_status == 'verified' %}
                      <span class="badge bg-success">‚úÖ QC Verified</span>
                    {% else %}
                      <span class="badge bg-warning text-dark">‚è≥ QC Pending</span>
                    {% endif %}

                    <button type="button" class="btn btn-sm {% if inv.qc_status == 'verified' %}btn-outline-warning{% else %}btn-success{% endif %} mt-2"
                            data-bs-toggle="collapse"
                            data-bs-target="#qcCollapse{{ inv.id }}"
                            aria-expanded="false">
                      <i class="fa fa-clipboard-check"></i>
                      {% if inv.qc_status == 'verified' %}Edit QC{% else %}Do QC{% endif %}
                    </button>
                  </div>
                </div>

                {% if inv.qc_status == 'verified' %}
                  <div class="mt-2">
                    <small class="text-muted d-block">Net: {{ inv.qc_weight or inv.qty }} Qt ‚Ä¢ Moisture: {{ inv.qc_moisture or '-' }}%</small>
                    {% if inv.qc_remarks %}
                      <small class="text-muted d-block">Remarks: {{ inv.qc_remarks }}</small>
                    {% endif %}
                    {% if inv.qc_at %}
                      <small class="text-muted d-block">Verified on {{ inv.qc_at[:16] }}</small>
                    {% endif %}
                  </div>
                {% endif %}

                <!-- QC Collapse (more reliable than modal inside tables) -->
                <div class="collapse mt-2" id="qcCollapse{{ inv.id }}">
                  <div class="card card-body">
                    <div class="fw-semibold mb-2">
                      {% if inv.qc_status == 'verified' %}
                        Edit Quality Check -
                      {% else %}
                        Quality Check -
                      {% endif %}
                      {% if inv.truck_number %}
                        Truck {{ inv.truck_number }}
                      {% else %}
                        Truck #{{ loop.index }}
                      {% endif %}
                    </div>

                    <form method="POST" action="/miller/update_qc/{{ inv.id }}">
                      <div class="row g-2 mb-2">
                        <div class="col-6">
                          <label class="form-label small mb-1">Net Weight (Qt)</label>
                          <input type="number"
                                 step="0.01"
                                 name="qc_weight"
                                 class="form-control form-control-sm"
                                 value="{{ inv.qc_weight or inv.qty }}"
                                 required>
                        </div>
                        <div class="col-6">
                          <label class="form-label small mb-1">Moisture (%)</label>
                          <input type="number"
                                 step="0.01"
                                 name="qc_moisture"
                                 class="form-control form-control-sm"
                                 value="{{ inv.qc_moisture or '' }}"
                                 required>
                        </div>
                      </div>
                      <div class="mb-2">
                        <label class="form-label small mb-1">Remarks (Optional)</label>
                        <textarea name="qc_remarks"
                                  class="form-control form-control-sm"
                                  rows="2"
                                  placeholder="Quality notes, deductions, etc.">{{ inv.qc_remarks or '' }}</textarea>
                      </div>
                      <div class="d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary"
                                data-bs-toggle="collapse"
                                data-bs-target="#qcCollapse{{ inv.id }}">
                          Cancel
                        </button>
                        <button type="submit" class="btn btn-sm btn-success">
                          <i class="fa fa-clipboard-check"></i> Save QC
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <span class="text-muted small">No loading yet</span>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
    </tbody>
  </table>
  </div>
  {% else %}
  <div class="empty-state">
    <i class="fa fa-truck"></i>
    <p>No orders currently being loaded.</p>
  </div>
  {% endif %}
</div>

<!-- COMPLETED LOADING (QC Section) -->
<div class="section-card" id="quality-check" data-aos="fade-up">
  <div class="section-header">
    <h5 class="section-title">
      <span class="icon-box blue"><i class="fa fa-clipboard-check"></i></span>
      Completed Loading - Quality Check
    </h5>
    <span class="section-badge bg-info" id="qcCount">{{ completed_loading_qc|length }} Orders</span>
  </div>

  {% if completed_loading_qc %}
  <!-- Filter & Search Bar -->
  <div class="filter-bar mb-4">
    <div class="d-flex gap-2 flex-wrap align-items-center">
      <button class="filter-pill active" data-filter="all" onclick="filterQC('all')">
        <i class="fa fa-list me-1"></i> All
      </button>
      <button class="filter-pill" data-filter="pending" onclick="filterQC('pending')">
        <i class="fa fa-clock me-1"></i> Pending QC
      </button>
      <button class="filter-pill" data-filter="verified" onclick="filterQC('verified')">
        <i class="fa fa-check-circle me-1"></i> Verified
      </button>
      <div class="flex-grow-1" style="min-width:200px;">
        <input type="text" 
               id="qcSearchInput" 
               class="form-control" 
               placeholder="üîç Search by Order ID, Buyer, or Crop..."
               onkeyup="searchQC()">
      </div>
    </div>
  </div>

  <!-- Scrollable Cards Container -->
  <div class="qc-scroll-container">
    <div class="row g-3" id="qcCardsContainer">
      {% for b in completed_loading_qc %}
      {% set booking_id = b[0] %}
      {% set booked = b[3] %}
      {% set loaded = b[7] %}
      {% set qc_weight = b[11] %}
      {% set qc_moisture = b[12] %}
      {% set qc_remarks = b[13] %}
      {% set qc_status = b[14] %}
      {% set qc_at = b[15] %}
      {% set order_id = b[10] %}
      {% set buyer_name = b[1] %}
      {% set crop_name = b[2] %}
      {% set payment_status = b[16] %}
      {% set final_invoice = b[17] %}
      {% set payment_at = b[18] %}

      <div class="col-md-6 qc-card-item" 
           data-search="{{ (order_id|string + ' ' + buyer_name|lower + ' ' + crop_name|lower) }}">
        <div class="card border-0 shadow-sm h-100 completed-loading-card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h6 class="mb-1"><strong class="text-primary">{{ b[10] }}</strong></h6>
              <p class="mb-1 text-muted small">{{ b[1] }} ‚Ä¢ <span class="text-capitalize">{{ b[2] }}</span></p>
              <div class="d-flex gap-2 mt-2">
                <span class="badge bg-primary">{{ booked }} Qt Booked</span>
                <span class="badge bg-success">{{ loaded }} Qt Loaded</span>
              </div>
            </div>
          </div>

          <!-- Per-Truck Quality Checks -->
          {% if invoices_map.get(booking_id) %}
            <div class="border-top pt-3">
              <small class="text-muted d-block mb-2 fw-semibold">
                <i class="fa fa-truck"></i> Truck Quality Checks:
              </small>
              
              {% for inv in invoices_map[booking_id] %}
                <div class="mb-3 p-2 border rounded" style="background:#f8f9fa;">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                      <strong class="text-primary">
                        {% if inv.truck_number %}
                          Truck {{ inv.truck_number }}
                        {% else %}
                          Truck #{{ loop.index }}
                        {% endif %}
                      </strong>
                      <span class="badge bg-info ms-2">{{ inv.qty }} Qt</span>
                      <a href="/static/uploads/bills/{{ inv.file }}"
                         target="_blank"
                         class="btn btn-sm btn-outline-primary ms-2">
                        <i class="fa fa-file-invoice"></i> Invoice
                      </a>
                    </div>
                    {% if inv.qc_status == 'verified' %}
                      <span class="badge bg-success">‚úÖ Verified</span>
                    {% else %}
                      <span class="badge bg-warning">‚è≥ Pending QC</span>
                    {% endif %}
                  </div>

                  {% if inv.qc_status == 'verified' %}
                    <!-- Show verified QC details for this truck -->
                    <div class="row g-2 mb-2">
                      <div class="col-6">
                        <small class="text-muted d-block">Net Weight</small>
                        <strong>{{ inv.qc_weight or inv.qty }} Qt</strong>
                      </div>
                      <div class="col-6">
                        <small class="text-muted d-block">Moisture</small>
                        <strong>{{ inv.qc_moisture or '-' }}%</strong>
                      </div>
                    </div>
                    {% if inv.qc_remarks %}
                      <div class="mb-2">
                        <small class="text-muted d-block">Remarks</small>
                        <small>{{ inv.qc_remarks }}</small>
                      </div>
                    {% endif %}
                    {% if inv.qc_at %}
                      <small class="text-muted">Verified on {{ inv.qc_at[:16] }}</small>
                    {% endif %}

                    <button type="button" class="btn btn-sm btn-outline-warning w-100 mt-2"
                            data-bs-toggle="collapse"
                            data-bs-target="#qcEdit{{ inv.id }}">
                      <i class="fa fa-pen-to-square"></i> Edit QC
                    </button>

                    <div class="collapse mt-2" id="qcEdit{{ inv.id }}">
                      <form method="POST" action="/miller/update_qc/{{ inv.id }}">
                        <div class="row g-2 mb-2">
                          <div class="col-6">
                            <label class="form-label small mb-1">Net Weight (Qt)</label>
                            <input type="number"
                                   step="0.01"
                                   name="qc_weight"
                                   class="form-control form-control-sm"
                                   value="{{ inv.qc_weight or inv.qty }}"
                                   required>
                          </div>
                          <div class="col-6">
                            <label class="form-label small mb-1">Moisture (%)</label>
                            <input type="number"
                                   step="0.01"
                                   name="qc_moisture"
                                   class="form-control form-control-sm"
                                   value="{{ inv.qc_moisture or '' }}"
                                   required>
                          </div>
                        </div>
                        <div class="mb-2">
                          <label class="form-label small mb-1">Remarks (Optional)</label>
                          <textarea name="qc_remarks"
                                    class="form-control form-control-sm"
                                    rows="2"
                                    placeholder="Quality notes, deductions, etc.">{{ inv.qc_remarks or '' }}</textarea>
                        </div>
                        <button type="submit" class="btn btn-sm btn-success w-100">
                          <i class="fa fa-clipboard-check"></i> Update QC
                        </button>
                      </form>
                    </div>
                  {% else %}
                    <!-- QC Form for this truck -->
                    <form method="POST" action="/miller/update_qc/{{ inv.id }}" class="mt-2">
                      <div class="row g-2 mb-2">
                        <div class="col-6">
                          <label class="form-label small mb-1">Net Weight (Qt)</label>
                          <input type="number"
                                 step="0.01"
                                 name="qc_weight"
                                 class="form-control form-control-sm"
                                 placeholder="Net Qt"
                                 value="{{ inv.qty }}"
                                 required>
                        </div>
                        <div class="col-6">
                          <label class="form-label small mb-1">Moisture (%)</label>
                          <input type="number"
                                 step="0.01"
                                 name="qc_moisture"
                                 class="form-control form-control-sm"
                                 placeholder="%"
                                 value="{{ inv.qc_moisture or '' }}"
                                 required>
                        </div>
                      </div>
                      <div class="mb-2">
                        <label class="form-label small mb-1">Remarks (Optional)</label>
                        <textarea name="qc_remarks"
                                  class="form-control form-control-sm"
                                  rows="2"
                                  placeholder="Quality notes, deductions, etc.">{{ inv.qc_remarks or '' }}</textarea>
                      </div>
                      <button class="btn btn-sm btn-success w-100">
                        <i class="fa fa-clipboard-check"></i> Save QC for This Truck
                      </button>
                    </form>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="border-top pt-3">
              <p class="text-muted small mb-0">No loading invoices yet.</p>
            </div>
          {% endif %}

          <!-- ================= UPLOAD FINAL INVOICE ================= -->
          {% set all_trucks_verified = true %}
          {% if invoices_map.get(booking_id) %}
            {% for inv in invoices_map[booking_id] %}
              {% if inv.qc_status != 'verified' %}
                {% set all_trucks_verified = false %}
              {% endif %}
            {% endfor %}
          {% else %}
            {% set all_trucks_verified = false %}
          {% endif %}

          {% if all_trucks_verified %}
            <div class="border-top mt-3 pt-3">
              <form method="POST"
                    action="/miller/upload_final_invoice/{{ booking_id }}"
                    enctype="multipart/form-data">

                <label class="form-label small fw-semibold mb-1">
                  <i class="fa fa-file-invoice"></i> Upload Final Invoice (Final Hisab)
                </label>

                <input type="file"
                       name="final_invoice"
                       class="form-control form-control-sm mb-2"
                       accept=".pdf,image/*"
                       required>

                <button class="btn btn-primary btn-sm w-100">
                  <i class="fa fa-upload"></i> Upload Final Invoice
                </button>
              </form>
            </div>
          {% else %}
            <div class="border-top mt-3 pt-3">
              <p class="text-muted small mb-0">
                <i class="fa fa-info-circle"></i> Complete all truck quality checks to upload final invoice.
              </p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
      {% endfor %}
    </div>
  </div>
  
  {% else %}
  <p class="text-muted">No completed loading orders yet.</p>
  {% endif %}
</div>

<!-- FINAL HISAB UPLOADED - PAYMENT PENDING -->
<div class="section-card" id="final-hisab" data-aos="fade-up">
  <div class="section-header">
    <h5 class="section-title">
      <span class="icon-box yellow"><i class="fa fa-file-invoice-dollar"></i></span>
      Final Hisab - Payment Pending
    </h5>
    <span class="section-badge bg-warning text-dark" id="finalInvoiceCount">{{ final_invoice_uploaded|length }} Pending</span>
  </div>

  {% if final_invoice_uploaded %}
  <div class="qc-scroll-container">
    <div class="row g-3">
      {% for b in final_invoice_uploaded %}
      {% set booking_id = b[0] %}
      {% set booked = b[3] %}
      {% set loaded = b[7] %}
      {% set order_id = b[10] %}
      {% set buyer_name = b[1] %}
      {% set crop_name = b[2] %}
      {% set payment_status = b[16] %}
      {% set final_invoice = b[17] %}
      {% set payment_at = b[18] %}

      <div class="col-md-6">
        <div class="card border-0 shadow-sm h-100 completed-loading-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <h6 class="mb-1"><strong class="text-primary">{{ b[10] }}</strong></h6>
                <p class="mb-1 text-muted small">{{ b[1] }} ‚Ä¢ <span class="text-capitalize">{{ b[2] }}</span></p>
                <div class="d-flex gap-2 mt-2">
                  <span class="badge bg-primary">{{ booked }} Qt Booked</span>
                  <span class="badge bg-success">{{ loaded }} Qt Loaded</span>
                </div>
              </div>
              <span class="badge bg-warning">üí∞ Payment Pending</span>
            </div>

            <!-- Final Invoice Info -->
            <div class="border-top pt-3">
              <div class="mb-3">
                <span class="badge bg-info mb-2">
                  <i class="fa fa-file-invoice"></i> Final Invoice Uploaded
                </span>
                {% if final_invoice %}
                  <a href="/static/uploads/bills/{{ final_invoice }}"
                     target="_blank"
                     class="btn btn-sm btn-outline-primary w-100 mt-2 mb-2">
                    <i class="fa fa-eye"></i> View Final Invoice
                  </a>
                  
                  <!-- Edit Final Invoice -->
                  <button class="btn btn-sm btn-warning w-100 mb-2"
                          data-bs-toggle="modal"
                          data-bs-target="#editFinalInvoice{{ booking_id }}">
                    <i class="fa fa-edit"></i> Edit/Replace Invoice
                  </button>
                  
                  <!-- Edit Modal -->
                  <div class="modal fade" id="editFinalInvoice{{ booking_id }}" tabindex="-1">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title">Edit Final Invoice</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <form method="POST"
                              action="/miller/edit_final_invoice/{{ booking_id }}"
                              enctype="multipart/form-data">
                          <div class="modal-body">
                            <div class="mb-3">
                              <label class="form-label">Upload New Invoice</label>
                              <input type="file"
                                     name="final_invoice"
                                     class="form-control"
                                     accept=".pdf,image/*"
                                     required>
                              <small class="text-muted">This will replace the existing invoice.</small>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-warning">
                              <i class="fa fa-upload"></i> Replace Invoice
                            </button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                {% endif %}
              </div>

              <!-- Mark Payment Done -->
              <form method="POST"
                    action="/miller/mark_payment_done/{{ booking_id }}">
                <button class="btn btn-success btn-sm w-100">
                  <i class="fa fa-check-circle"></i> Mark Payment Done
                </button>
              </form>
            </div>

            <!-- Per-Truck QC Summary -->
            {% if invoices_map.get(booking_id) %}
              <div class="border-top mt-3 pt-3">
                <small class="text-muted d-block mb-2 fw-semibold">
                  <i class="fa fa-truck"></i> Truck QC Summary:
                </small>
                {% for inv in invoices_map[booking_id] %}
                  <div class="mb-2 p-2 border rounded" style="background:#f8f9fa;">
                    <div class="d-flex justify-content-between">
                      <span>
                        <strong>
                          {% if inv.truck_number %}
                            Truck {{ inv.truck_number }}
                          {% else %}
                            Truck #{{ loop.index }}
                          {% endif %}
                        </strong>
                        - {{ inv.qty }} Qt
                      </span>
                      {% if inv.qc_status == 'verified' %}
                        <span class="badge bg-success">‚úÖ</span>
                      {% else %}
                        <span class="badge bg-warning">‚è≥</span>
                      {% endif %}
                    </div>
                    {% if inv.qc_status == 'verified' %}
                      <small class="text-muted">
                        Net: {{ inv.qc_weight or inv.qty }} Qt | 
                        Moisture: {{ inv.qc_moisture or '-' }}%
                      </small>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  
  {% else %}
  <p class="text-muted">No orders with final invoice uploaded yet.</p>
  {% endif %}
</div>

<!-- PAYMENT COMPLETED -->
{% if payment_completed %}
<div class="section-card">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h6 class="section-title mb-0">
      <i class="fa fa-check-circle" style="color:#198754;"></i> Payment Completed
    </h6>
    <span class="badge bg-success">{{ payment_completed|length }} Orders</span>
  </div>

  <div class="qc-scroll-container">
    <div class="row g-3">
      {% for b in payment_completed %}
      {% set booking_id = b[0] %}
      {% set booked = b[3] %}
      {% set loaded = b[7] %}
      {% set order_id = b[10] %}
      {% set buyer_name = b[1] %}
      {% set crop_name = b[2] %}
      {% set payment_status = b[16] %}
      {% set final_invoice = b[17] %}
      {% set payment_at = b[18] %}

      <div class="col-md-6">
        <div class="card border-0 shadow-sm h-100 completed-loading-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <h6 class="mb-1"><strong class="text-primary">{{ b[10] }}</strong></h6>
                <p class="mb-1 text-muted small">{{ b[1] }} ‚Ä¢ <span class="text-capitalize">{{ b[2] }}</span></p>
                <div class="d-flex gap-2 mt-2">
                  <span class="badge bg-primary">{{ booked }} Qt Booked</span>
                  <span class="badge bg-success">{{ loaded }} Qt Loaded</span>
                </div>
              </div>
              <span class="badge bg-success">‚úÖ Payment Completed</span>
            </div>

            <div class="border-top pt-3">
              {% if final_invoice %}
                <a href="/static/uploads/bills/{{ final_invoice }}"
                   target="_blank"
                   class="btn btn-sm btn-outline-primary w-100 mb-2">
                  <i class="fa fa-eye"></i> View Final Invoice
                </a>
                
                <!-- Edit Final Invoice -->
                <button class="btn btn-sm btn-warning w-100 mb-2"
                        data-bs-toggle="modal"
                        data-bs-target="#editFinalInvoicePaid{{ booking_id }}">
                  <i class="fa fa-edit"></i> Edit/Replace Invoice
                </button>
                
                <!-- Edit Modal -->
                <div class="modal fade" id="editFinalInvoicePaid{{ booking_id }}" tabindex="-1">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">Edit Final Invoice</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <form method="POST"
                            action="/miller/edit_final_invoice/{{ booking_id }}"
                            enctype="multipart/form-data">
                        <div class="modal-body">
                          <div class="mb-3">
                            <label class="form-label">Upload New Invoice</label>
                            <input type="file"
                                   name="final_invoice"
                                   class="form-control"
                                   accept=".pdf,image/*"
                                   required>
                            <small class="text-muted">This will replace the existing invoice.</small>
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <button type="submit" class="btn btn-warning">
                            <i class="fa fa-upload"></i> Replace Invoice
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              {% endif %}

              {% if payment_at %}
                <small class="text-muted d-block text-center">
                  Paid on {{ payment_at[:16] }}
                </small>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

<!-- REJECTED -->
<div class="section-card" id="rejected-orders" data-aos="fade-up">
  <div class="section-header">
    <h5 class="section-title">
      <span class="icon-box red"><i class="fa fa-times-circle"></i></span>
      Rejected Orders
    </h5>
    <span class="section-badge bg-danger">{{ rejected|length }} Rejected</span>
  </div>

  {% if rejected %}
<div class="table-responsive">
<table class="table-modern">
  <thead>
  <tr>
    <th>Order ID</th>
    <th>Buyer</th>
    <th>Crop</th>
    <th>Quantity</th>
    <th>Rejection Reason</th>
  </tr>
  </thead>
  <tbody>

  {% for b in rejected %}
  <tr class="booking-row"
      data-status="declined"
      data-buyer="{{ b[1]|lower }}"
      data-crop="{{ b[2]|lower }}">

    <td><strong class="text-primary">{{ b[10] if b[10] else 'N/A' }}</strong></td>
    <td>{{ b[1] }}</td>
    <td>{{ b[2] }}</td>
    <td>
      <span class="badge bg-danger qty-badge">{{ b[3] }} Qt</span>
    </td>
    <td>{{ b[5] }}</td>
  </tr>
  {% endfor %}
  </tbody>
</table>
</div>
{% else %}
<div class="empty-state">
  <i class="fa fa-check-circle text-success"></i>
  <p>No rejected orders. Great!</p>
</div>
{% endif %}

</div>
<!-- End of Rejected Orders Section -->

<script>
  function applyFilters() {
    const status = document.getElementById("statusFilter").value;
    const buyer = document.getElementById("buyerFilter").value.toLowerCase();
    const crop  = document.getElementById("cropFilter").value.toLowerCase();
  
    document.querySelectorAll(".booking-row").forEach(row => {
      const rowStatus = row.dataset.status;
      const rowBuyer  = row.dataset.buyer;
      const rowCrop   = row.dataset.crop;
  
      const matchStatus = (status === "all" || status === rowStatus);
      const matchBuyer  = rowBuyer.includes(buyer);
      const matchCrop   = rowCrop.includes(crop);
  
      if (matchStatus && matchBuyer && matchCrop) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    });
  }
  
  function clearFilters() {
    document.getElementById("statusFilter").value = "all";
    document.getElementById("buyerFilter").value = "";
    document.getElementById("cropFilter").value = "";
    applyFilters();
  }
  
  document.getElementById("statusFilter").addEventListener("change", applyFilters);
  document.getElementById("buyerFilter").addEventListener("keyup", applyFilters);
  document.getElementById("cropFilter").addEventListener("keyup", applyFilters);

  window.onload = applyFilters;

  // QC Filter & Search Functions
  let currentQCFilter = 'all';
  
  function filterQC(status) {
    currentQCFilter = status;
    
    // Update button states
    document.querySelectorAll('.filter-pill').forEach(btn => {
      btn.classList.remove('active');
      if(btn.dataset.filter === status) {
        btn.classList.add('active');
      }
    });
    
    // Apply filter
    applyQCFilter();
  }
  
  function searchQC() {
    applyQCFilter();
  }
  
  function applyQCFilter() {
    const searchTerm = document.getElementById('qcSearchInput')?.value.toLowerCase() || '';
    const cards = document.querySelectorAll('.qc-card-item');
    let visibleCount = 0;
    
    cards.forEach(card => {
      const searchText = card.dataset.search || '';
      
      // Check if this card has any pending trucks
      const pendingBadges = card.querySelectorAll('.badge.bg-warning');
      const verifiedBadges = card.querySelectorAll('.badge.bg-success');
      const hasPending = pendingBadges.length > 0;
      const allVerified = verifiedBadges.length > 0 && pendingBadges.length === 0;
      
      // Status filter - check per-truck status
      let statusMatch = true;
      if (currentQCFilter === 'pending') {
        statusMatch = hasPending;
      } else if (currentQCFilter === 'verified') {
        statusMatch = allVerified && verifiedBadges.length > 0;
      }
      
      // Search filter
      const searchMatch = !searchTerm || searchText.includes(searchTerm);
      
      if (statusMatch && searchMatch) {
        card.style.display = '';
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    });
    
    // Update count badge
    const countBadge = document.getElementById('qcCount');
    if(countBadge) {
      countBadge.textContent = `${visibleCount} Orders`;
    }
  }
  
  // Initialize QC search on page load
  const qcSearchInput = document.getElementById('qcSearchInput');
  if(qcSearchInput) {
    qcSearchInput.addEventListener('input', searchQC);
  }

  // ================= Approved Loading Filter & Search =================
  let currentApprovedLoadingFilter = 'all';

  function setApprovedLoadingButtonState(activeFilter) {
    document.querySelectorAll('.approved-loading-filter-btn').forEach(btn => {
      const isActive = btn.dataset.filter === activeFilter;
      btn.classList.toggle('btn-success', isActive);
      btn.classList.toggle('btn-outline-secondary', !isActive);
    });
  }

  function filterApprovedLoading(status) {
    currentApprovedLoadingFilter = status;
    setApprovedLoadingButtonState(status);
    applyApprovedLoadingFilter();
  }

  function searchApprovedLoading() {
    applyApprovedLoadingFilter();
  }

  function applyApprovedLoadingFilter() {
    const searchTerm = (document.getElementById('approvedLoadingSearchInput')?.value || '').toLowerCase();
    const rows = document.querySelectorAll('.approved-loading-row');
    let visibleCount = 0;

    rows.forEach(row => {
      const qc = row.dataset.qc || 'none';
      const searchText = row.dataset.search || '';

      const statusMatch = (currentApprovedLoadingFilter === 'all') || (qc === currentApprovedLoadingFilter);
      const searchMatch = !searchTerm || searchText.includes(searchTerm);

      if (statusMatch && searchMatch) {
        row.style.display = '';
        visibleCount++;
      } else {
        row.style.display = 'none';
      }
    });

    const countBadge = document.getElementById('approvedLoadingCount');
    if (countBadge) {
      countBadge.textContent = `${visibleCount} Active`;
    }
  }

  const approvedLoadingSearchInput = document.getElementById('approvedLoadingSearchInput');
  if (approvedLoadingSearchInput) {
    approvedLoadingSearchInput.addEventListener('input', searchApprovedLoading);
  }

  // Initialize approved-loading filters
  setApprovedLoadingButtonState('all');
  applyApprovedLoadingFilter();

  </script>
  
</div> <!-- container -->
</main>

{% include '_footer.html' %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>AOS.init({duration:600,once:true});</script>
</body>
</html>

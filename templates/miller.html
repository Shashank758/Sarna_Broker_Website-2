<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Miller Dashboard | Sarna Broker</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  :root{
    --mandi-brown:#8b6f47;
    --mandi-dark:#6b5638;
    --mandi-light:#d4c4a8;
    --mandi-bg:#f5f3f0;
    --mandi-card:#ffffff;
    --mandi-text:#3a3429;
    --mandi-border:#d4c4a8;
    --mandi-success:#6b8e23;
    --radius:8px;
  }
  
  /* ---------- GLOBAL ---------- */
  body{
    background:var(--mandi-bg);
    font-family:"Segoe UI", "Roboto", sans-serif;
    color:var(--mandi-text);
    line-height:1.6;
    min-height:100vh;
    display:flex;
    flex-direction:column;
  }
  
  /* ---------- HEADER ---------- */
  .mandi-header{
    background:#8b6f47;
    color:#fff;
    padding:24px 28px;
    border-radius:var(--radius);
    margin-top:20px;
    box-shadow:0 2px 8px rgba(0,0,0,.1);
    border-bottom:3px solid #6b5638;
  }
  .mandi-header h4{
    font-weight:700;
    letter-spacing:.5px;
    font-size:24px;
    margin:0;
  }
  .mandi-header small{
    opacity:.95;
    font-size:14px;
    display:block;
    margin-top:4px;
  }
  
  /* ---------- PROFILE BUTTON ---------- */
  .profile-btn{
    position:absolute;
    right:24px;
    top:50%;
    transform:translateY(-50%);
    border-radius:6px;
    padding:8px 16px;
    font-weight:600;
    background:rgba(255,255,255,.15);
    border:1px solid rgba(255,255,255,.3);
    color:#fff;
    transition:all .2s;
  }
  .profile-btn:hover{
    background:rgba(255,255,255,.25);
    color:#fff;
  }
  
  /* ---------- CARDS ---------- */
  .section-card{
    background:var(--mandi-card);
    border-radius:var(--radius);
    padding:24px;
    margin-bottom:24px;
    box-shadow:0 1px 3px rgba(0,0,0,.1);
    border:1px solid var(--mandi-border);
  }
  
  /* ---------- TITLES ---------- */
  .section-title{
    font-weight:700;
    margin-bottom:20px;
    font-size:18px;
    display:flex;
    align-items:center;
    gap:10px;
    color:var(--mandi-dark);
    padding-bottom:12px;
    border-bottom:2px solid var(--mandi-border);
  }
  
  /* ---------- FILTER CARD ---------- */
  .card{
    border-radius:var(--radius);
    border:1px solid var(--mandi-border);
    box-shadow:0 1px 3px rgba(0,0,0,.08);
    background:var(--mandi-card);
  }
  
  /* ---------- TABLE ---------- */
  .table{
    margin-bottom:0;
    border-color:var(--mandi-border);
  }
  .table th{
    background:#f5f3f0;
    text-align:center;
    font-size:13px;
    font-weight:700;
    border:1px solid var(--mandi-border);
    color:var(--mandi-dark);
    padding:12px 8px;
  }
  .table td{
    text-align:center;
    vertical-align:middle;
    font-size:14px;
    border:1px solid var(--mandi-border);
    padding:10px 8px;
  }
  .table tr:hover{
    background:#faf9f7;
  }
  
  /* ---------- BADGES ---------- */
  .badge{
    font-size:12px;
    padding:5px 10px;
    border-radius:4px;
    font-weight:600;
  }
  .qty-badge{
    font-weight:700;
  }
  
  /* ---------- BUTTONS ---------- */
  .btn-agri{
    background:var(--mandi-brown);
    color:#fff;
    border:none;
    font-weight:600;
    border-radius:6px;
    padding:12px 20px;
    transition:all .2s;
  }
  .btn-agri:hover{
    background:var(--mandi-dark);
    color:#fff;
  }
  
  .btn-success{
    background:var(--mandi-success);
    border:none;
    border-radius:6px;
    font-weight:600;
  }
  .btn-success:hover{
    background:#556b2f;
  }
  
  .btn-danger{
    border-radius:6px;
    font-weight:600;
  }
  
  /* ---------- ALERT STATS ---------- */
  .alert{
    border-radius:var(--radius);
    font-weight:600;
    border:1px solid var(--mandi-border);
    background:#fff;
  }
  
  /* ---------- INPUTS ---------- */
  .form-control, .form-select{
    border-radius:6px;
    padding:10px 12px;
    border:1px solid var(--mandi-border);
    background:#fff;
  }
  .form-control:focus, .form-select:focus{
    border-color:var(--mandi-brown);
    box-shadow:0 0 0 .2rem rgba(139,111,71,.15);
    background:#fff;
  }
  .form-label{
    font-weight:600;
    color:var(--mandi-dark);
    margin-bottom:6px;
    font-size:14px;
  }
  
  /* ---------- ACTION AREA ---------- */
  td form input{
    border-radius:8px;
  }
  
  /* ---------- MOBILE ---------- */
  @media(max-width:768px){
    .profile-btn{
      position:static;
      margin-top:12px;
    }
  }

  /* ---------- COMPLETED LOADING CARDS ---------- */
  .completed-loading-card{
    transition:transform .2s ease, box-shadow .2s ease;
  }
  .completed-loading-card:hover{
    transform:translateY(-2px);
    box-shadow:0 12px 30px rgba(0,0,0,.12) !important;
  }
  .qc-scroll-container{
    max-height:65vh;
    overflow-y:auto;
    padding-right:8px;
  }
  .qc-scroll-container::-webkit-scrollbar{
    width:10px;
  }
  .qc-scroll-container::-webkit-scrollbar-thumb{
    background:#cbd5e0;
    border-radius:999px;
    border:3px solid transparent;
    background-clip:content-box;
  }
  .qc-scroll-container::-webkit-scrollbar-track{
    background:#f1f5f9;
    border-radius:999px;
  }
  .qc-filter-bar{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
    margin-bottom:16px;
    padding:12px;
    background:#f8f9fa;
    border-radius:12px;
  }
  .qc-filter-btn{
    padding:6px 14px;
    border-radius:20px;
    font-weight:600;
    font-size:13px;
    border:2px solid transparent;
    background:#fff;
    cursor:pointer;
    transition:all .2s;
  }
  .qc-filter-btn.active{
    background:var(--green);
    color:#fff;
    border-color:var(--green);
  }
  .qc-filter-btn:hover:not(.active){
    background:#e9ecef;
  }
  .qc-search-box{
    flex:1;
    min-width:200px;
  }

  /* ---------- NAVBAR ---------- */
  .navbar{
    background:linear-gradient(90deg,#8b6f47,#6b5638);
    border-radius:0;
  }
  .navbar-brand{
    font-weight:900;
    color:#fff !important;
  }
  .nav-link{
    font-weight:700;
    color:#fff !important;
    transition:all .2s;
  }
  .nav-link:hover{
    background:rgba(255,255,255,.1);
    border-radius:6px;
  }
  .nav-link.active{
    background:rgba(255,255,255,.2);
    border-radius:6px;
  }

  /* ---------- FOOTER ---------- */
  .footer{
    background:#0b1c2d;
    color:#cfd6df;
    padding:40px 0 20px;
    margin-top:auto;
  }
  .footer h6{
    color:#fff;
    font-weight:800;
  }
  .footer a{
    color:#cfd6df;
    text-decoration:none;
  }
  .footer a:hover{
    color:#fff;
  }
  .footer-bottom{
    border-top:1px solid rgba(255,255,255,.1);
    margin-top:20px;
    padding-top:15px;
    font-size:.85rem;
    text-align:center;
  }

  /* ---------- SCROLL TO SECTION ---------- */
  html{
    scroll-behavior:smooth;
  }
  </style>
  
</head>

<body class="bg-light">
<div style="display:flex; flex-direction:column; min-height:100vh;">
<!-- ================= NAVBAR ================= -->
<nav class="navbar navbar-expand-lg navbar-dark sticky-top">
  <div class="container">
    <a class="navbar-brand" href="/miller">
      <i class="fa fa-industry"></i> Miller Dashboard
    </a>

    <button class="navbar-toggler" type="button"
            data-bs-toggle="collapse"
            data-bs-target="#millerNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="millerNav">
      <ul class="navbar-nav ms-auto">

        {% if session['is_staff'] %}
        <li class="nav-item">
          <span class="nav-link"
                style="background:#d4a574;
                       color:#3a3429 !important;
                       border-radius:6px;
                       margin-right:10px;">
            <i class="fa fa-user-shield me-1"></i> STAFF MODE
          </span>
        </li>
        {% endif %}

        <!-- üîÅ REDIRECTING LINKS -->
        <li class="nav-item">
          <a class="nav-link {% if request.path == '/miller/approved' %}active{% endif %}"
             href="/miller/approved">
            <i class="fa fa-clock me-1"></i> Approved Orders
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link {% if request.path == '/miller/qc' %}active{% endif %}"
             href="/miller/qc">
            <i class="fa fa-clipboard-check me-1"></i> Quality Check
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link {% if request.path == '/miller/final-hisab' %}active{% endif %}"
             href="/miller/final-hisab">
            <i class="fa fa-file-invoice me-1"></i> Final Hisab
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if request.path == '/miller/payment-completed' %}active{% endif %}"
             href="/miller/payment-completed">
            <i class="fa fa-check-circle me-1"></i> Payment Completed
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if request.path == '/miller/rejected' %}active{% endif %}"
             href="/miller/rejected">
            <i class="fa fa-times-circle me-1"></i> Rejected
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link {% if request.path == '/miller/profile' %}active{% endif %}"
             href="/miller/profile">
            <i class="fa fa-user me-1"></i> Profile
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>


<main class="flex-fill">
<div class="container mb-5" style="max-width:1200px;">

<!-- ================= DASHBOARD HEADER ================= -->
<div class="mandi-header position-relative mt-4">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h4><i class="fa fa-industry me-2"></i> Miller Trading Dashboard</h4>
      <small><i class="fa fa-chart-line me-1"></i> Manage stock, approve orders & view trade status</small>
    </div>
  </div>
</div>

<!-- ================= QUICK STATS ================= -->
{% set total_stocks = stocks|length %}
{% set total_pending = pending|length %}
{% set total_approved = approved|length %}
{% set total_completed = completed_loading_qc|length if completed_loading_qc else 0 %}

<div class="row g-3 mt-3 mb-4">
  <div class="col-md-3">
    <div class="card border-0" style="background:#fff; border-left:3px solid #8b6f47 !important; box-shadow:0 1px 3px rgba(0,0,0,.1);">
      <div class="card-body p-3">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted d-block" style="font-size:11px; text-transform:uppercase; font-weight:600;">Active Stocks</small>
            <h5 class="mb-0 mt-1" style="font-weight:700; color:#3a3429;">{{ total_stocks }}</h5>
          </div>
          <div style="width:40px; height:40px; background:#f5f3f0; border-radius:6px; display:flex; align-items:center; justify-content:center; color:#8b6f47;">
            <i class="fa fa-warehouse"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-0" style="background:#fff; border-left:3px solid #d4a574 !important; box-shadow:0 1px 3px rgba(0,0,0,.1);">
      <div class="card-body p-3">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted d-block" style="font-size:11px; text-transform:uppercase; font-weight:600;">Pending</small>
            <h5 class="mb-0 mt-1" style="font-weight:700; color:#3a3429;">{{ total_pending }}</h5>
          </div>
          <div style="width:40px; height:40px; background:#f5f3f0; border-radius:6px; display:flex; align-items:center; justify-content:center; color:#d4a574;">
            <i class="fa fa-clock"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-0" style="background:#fff; border-left:3px solid #6b8e23 !important; box-shadow:0 1px 3px rgba(0,0,0,.1);">
      <div class="card-body p-3">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted d-block" style="font-size:11px; text-transform:uppercase; font-weight:600;">Approved</small>
            <h5 class="mb-0 mt-1" style="font-weight:700; color:#3a3429;">{{ total_approved }}</h5>
          </div>
          <div style="width:40px; height:40px; background:#f5f3f0; border-radius:6px; display:flex; align-items:center; justify-content:center; color:#6b8e23;">
            <i class="fa fa-check-circle"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card border-0" style="background:#fff; border-left:3px solid #8b7355 !important; box-shadow:0 1px 3px rgba(0,0,0,.1);">
      <div class="card-body p-3">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted d-block" style="font-size:11px; text-transform:uppercase; font-weight:600;">Completed</small>
            <h5 class="mb-0 mt-1" style="font-weight:700; color:#3a3429;">{{ total_completed }}</h5>
          </div>
          <div style="width:40px; height:40px; background:#f5f3f0; border-radius:6px; display:flex; align-items:center; justify-content:center; color:#8b7355;">
            <i class="fa fa-truck"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ================= POST STOCK ================= -->
<div class="section-card">
  <h6 class="section-title">
    <i class="fa fa-plus-circle" style="color:#8b6f47;"></i> Post New Stock
  </h6>

  <form method="POST">
    <div class="row g-3">

      <div class="col-md-4">
        <label class="form-label">Crop</label>
        <select name="crop" class="form-control" required>
          <option value="">Select Crop</option>
          <option>wheat</option>
          <option>chawal</option>
          <option>sarso</option>
          <option>maize</option>
          <option>paddy</option>
          <option>mustard oil cake</option>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">Quantity (Quintal)</label>
        <input type="number" name="quantity" class="form-control" min="1" required>
      </div>

      <div class="col-md-4">
        <label class="form-label">Price / Quintal</label>
        <input type="number" name="price" class="form-control" min="1" required>
      </div>

      <div class="col-md-4">
        <label class="form-label">Condition</label>
        <select name="condition" class="form-control">
          <option>Net</option>
          <option>Full</option>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">Bag Type</label>
        <select name="bag_type" class="form-control">
          <option>Jute</option>
          <option>Plastic</option>
          <option>Jute/Plastic</option>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">Deduction</label>
        <input type="text"
               name="deduction"
               placeholder="Enter deduction note"
               class="form-control form-control-sm">
      </div>
      

      <div class="col-12">
        <button class="btn btn-agri w-100">
          <i class="fa fa-upload"></i> Post Stock
        </button>
      </div>
    </div>
  </form>
</div>
<!-- ================= LIVE STOCK ================= -->
<div class="section-card">
  <h6 class="section-title">
    <i class="fa fa-warehouse" style="color:#8b6f47;"></i> Live Stock
  </h6>

  <div class="table-responsive">
    <table class="table table-bordered table-hover">
      <tr>
        <th>Crop</th>
        <th>Qty</th>
        <th>Price</th>
        <th>Condition</th>
        <th>Bag</th>
        <th>Deduction</th>
        <th>Update</th>
      </tr>

      {% for s in stocks %}
      <form method="POST" action="/update_miller_stock/{{ s[0] }}">
      <tr>
        <td><b>{{ s[2] }}</b></td>
        <td><input type="number" name="quantity" value="{{ s[3] }}" class="form-control form-control-sm"></td>
        <td><input type="number" name="price" value="{{ s[4] }}" class="form-control form-control-sm"></td>
        <td>
          <select name="condition" class="form-control form-control-sm">
            <option {{ 'selected' if s[5]=='Net' }}>Net</option>
            <option {{ 'selected' if s[5]=='Full' }}>Full</option>
          </select>
        </td>
        <td>
          <select name="bag_type" class="form-control form-control-sm">
            <option {{ 'selected' if s[6]=='Jute' }}>Jute</option>
            <option {{ 'selected' if s[6]=='Plastic' }}>Plastic</option>
          <option {{ 'selected' if s[6]=='Jute/Plastic' }}>Jute/Plastic</option>
          </select>
        </td>
        <td><input type="text" name="deduction" value="{{ s[7] }}" class="form-control form-control-sm"></td>
        <td><button class="btn btn-sm btn-primary w-100">Update</button></td>
      </tr>
      </form>
      {% endfor %}
    </table>
  </div>
</div>

<!-- ================= ORDERS ================= -->
{% set pending = bookings | selectattr(4,'equalto','pending') | list %}
{% set approved = bookings | selectattr(4,'equalto','approved') | list %}
{% set rejected = bookings | selectattr(4,'equalto','declined') | list %}

<!-- ================= BOOKING FILTER ================= -->
<div class="card mb-4 shadow-sm">
  <div class="card-body">
    <div class="row g-2 align-items-end">

      <div class="col-md-3">
        <label class="form-label fw-semibold">Filter by Status</label>
        <select id="statusFilter" class="form-select">
          <option value="all">All</option>
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="declined">Rejected</option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label fw-semibold">Buyer Name</label>
        <input type="text" id="buyerFilter"
               class="form-control"
               placeholder="Search buyer">
      </div>

      <div class="col-md-3">
        <label class="form-label fw-semibold">Crop</label>
        <input type="text" id="cropFilter"
               class="form-control"
               placeholder="Search crop">
      </div>

      <div class="col-md-3">
        <button onclick="clearFilters()"
                class="btn btn-outline-secondary w-100">
          Clear Filters
        </button>
      </div>

    </div>
  </div>
</div>

<!-- PENDING -->
<div class="section-card">
  <h6 class="section-title">
    <i class="fa fa-clock" style="color:#d4a574;"></i> Order Requests
  </h6>

  {% if pending %}
  <table class="table table-bordered">
    <tr>
      <th>Order ID</th><th>Buyer</th><th>Crop</th><th>Qty</th><th>Action</th>
    </tr>

    {% for b in pending %}
    <tr class="booking-row"
        data-status="pending"
        data-buyer="{{ b[1]|lower }}"
        data-crop="{{ b[2]|lower }}">

      <td><strong class="text-primary">{{ b[10] if b[10] else 'N/A' }}</strong></td>
      <td>{{ b[1] }}</td>
      <td>{{ b[2] }}</td>
      <td><span class="badge bg-success qty-badge">{{ b[3] }} Qt</span></td>
      <td>
        <a href="/miller/approve_booking/{{ b[0] }}"
           class="btn btn-sm btn-success w-100 mb-1">
           Approve
        </a>

        <form method="POST" action="/miller/decline_booking/{{ b[0] }}">
          <input name="reason"
                 class="form-control form-control-sm mb-1"
                 placeholder="Reject reason"
                 required>
          <button class="btn btn-sm btn-danger w-100">Reject</button>
        </form>
      </td>
    </tr>
    {% endfor %}

  </table>
  {% else %}
    <p class="text-muted">No pending orders.</p>
  {% endif %}
</div>
<!-- APPROVED (Still Loading) -->
{% set approved_loading = [] %}
{% set completed_loading_qc = [] %}
{% set final_invoice_uploaded = [] %}
{% set payment_completed = [] %}
{% for b in approved %}
  {% set booked = b[3] %}
  {% set loaded = b[7] %}
  {% set payment_status = b[16] %}
  {% set final_invoice = b[17] %}
  {% if loaded < booked and b[8] != 'partial_closed' %}
    {% set _ = approved_loading.append(b) %}
  {% elif payment_status == 'paid' %}
    {% set _ = payment_completed.append(b) %}
  {% elif final_invoice and payment_status != 'paid' %}
    {% set _ = final_invoice_uploaded.append(b) %}
  {% else %}
    {% set _ = completed_loading_qc.append(b) %}
  {% endif %}
{% endfor %}

<div class="section-card" id="approved-loading">
  <h6 class="section-title">
    <i class="fa fa-check-circle" style="color:#6b8e23;"></i> Approved Orders (Still Loading)
  </h6>

  {% if approved_loading %}
  <table class="table table-bordered">
    <tr>
      <th>Order ID</th>
      <th>Buyer</th>
      <th>Crop</th>
      <th>Booked</th>
      <th>Loaded</th>
      <th>Remaining</th>
      <th>Invoices (Per Truck)</th>
      <th>Close Reason</th>
    </tr>
  
    {% for b in approved_loading %}
    {% set booking_id = b[0] %}
    {% set booked = b[3] %}
    {% set loaded = b[7] %}
    {% set remaining = booked - loaded %}
  
    <tr>
      <td><strong class="text-primary">{{ b[10] }}</strong></td>
      <td>{{ b[1] }}</td>
      <td>{{ b[2] }}</td>
  
      <td><span class="badge bg-primary">{{ booked }} Qt</span></td>
  
      <td>
        <span class="badge bg-success">{{ loaded }} Qt</span>
      </td>
  
      <td>
        <span class="badge bg-warning">{{ remaining }} Qt</span>
      </td>
      <td>
        {% if b[8] == 'partial_closed' and b[9] %}
          <span class="badge bg-warning text-dark">
            <i class="fa fa-lock"></i> Closed
          </span>
          <div class="small text-muted mt-1">
            {{ b[9] }}
          </div>
        {% else %}
          <span class="text-muted small">‚Äî</span>
        {% endif %}
      </td>
      
      <!-- üî¥ PER LOADING INVOICES -->
      <td>
        {% if invoices_map.get(booking_id) %}
          <ul class="list-unstyled mb-0">
            {% for inv in invoices_map[booking_id] %}
              <li class="mb-1">
                <span class="badge bg-info">
                  {{ inv.qty }} Qt
                </span>
  
                <a href="/static/uploads/bills/{{ inv.file }}"
                   target="_blank"
                   class="btn btn-sm btn-outline-primary ms-1">
                  <i class="fa fa-file-invoice"></i> Invoice
                </a>
  
                <small class="text-muted d-block">
                  {{ inv.date[:16] }}
                </small>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <span class="text-muted small">No loading yet</span>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </table>
  
  {% else %}
  <p class="text-muted">No orders currently loading.</p>
  {% endif %}
</div>

<!-- COMPLETED LOADING (QC Section) -->
<div class="section-card" id="quality-check">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h6 class="section-title mb-0">
      <i class="fa fa-truck" style="color:#8b7355;"></i> Completed Loading - Quality Check
    </h6>
    <span class="badge bg-info" id="qcCount">{{ completed_loading_qc|length }} Orders</span>
  </div>

  {% if completed_loading_qc %}
  <!-- Filter & Search Bar -->
  <div class="qc-filter-bar">
    <button class="qc-filter-btn active" data-filter="all" onclick="filterQC('all')">
      <i class="fa fa-list"></i> All
    </button>
    <button class="qc-filter-btn" data-filter="pending" onclick="filterQC('pending')">
      <i class="fa fa-clock"></i> Pending QC
    </button>
    <button class="qc-filter-btn" data-filter="verified" onclick="filterQC('verified')">
      <i class="fa fa-check-circle"></i> Verified
    </button>
    <div class="qc-search-box">
      <input type="text" 
             id="qcSearchInput" 
             class="form-control form-control-sm" 
             placeholder="Search by Order ID, Buyer, or Crop..."
             onkeyup="searchQC()">
    </div>
  </div>

  <!-- Scrollable Cards Container -->
  <div class="qc-scroll-container">
    <div class="row g-3" id="qcCardsContainer">
      {% for b in completed_loading_qc %}
      {% set booking_id = b[0] %}
      {% set booked = b[3] %}
      {% set loaded = b[7] %}
      {% set qc_weight = b[11] %}
      {% set qc_moisture = b[12] %}
      {% set qc_remarks = b[13] %}
      {% set qc_status = b[14] %}
      {% set qc_at = b[15] %}
      {% set order_id = b[10] %}
      {% set buyer_name = b[1] %}
      {% set crop_name = b[2] %}
      {% set payment_status = b[16] %}
      {% set final_invoice = b[17] %}
      {% set payment_at = b[18] %}

      <div class="col-md-6 qc-card-item" 
           data-search="{{ (order_id|string + ' ' + buyer_name|lower + ' ' + crop_name|lower) }}">
        <div class="card border-0 shadow-sm h-100 completed-loading-card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h6 class="mb-1"><strong class="text-primary">{{ b[10] }}</strong></h6>
              <p class="mb-1 text-muted small">{{ b[1] }} ‚Ä¢ <span class="text-capitalize">{{ b[2] }}</span></p>
              <div class="d-flex gap-2 mt-2">
                <span class="badge bg-primary">{{ booked }} Qt Booked</span>
                <span class="badge bg-success">{{ loaded }} Qt Loaded</span>
              </div>
            </div>
          </div>

          <!-- Per-Truck Quality Checks -->
          {% if invoices_map.get(booking_id) %}
            <div class="border-top pt-3">
              <small class="text-muted d-block mb-2 fw-semibold">
                <i class="fa fa-truck"></i> Truck Quality Checks:
              </small>
              
              {% for inv in invoices_map[booking_id] %}
                <div class="mb-3 p-2 border rounded" style="background:#f8f9fa;">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                      <strong class="text-primary">Truck #{{ loop.index }}</strong>
                      <span class="badge bg-info ms-2">{{ inv.qty }} Qt</span>
                      <a href="/static/uploads/bills/{{ inv.file }}"
                         target="_blank"
                         class="btn btn-sm btn-outline-primary ms-2">
                        <i class="fa fa-file-invoice"></i> Invoice
                      </a>
                    </div>
                    {% if inv.qc_status == 'verified' %}
                      <span class="badge bg-success">‚úÖ Verified</span>
                    {% else %}
                      <span class="badge bg-warning">‚è≥ Pending QC</span>
                    {% endif %}
                  </div>

                  {% if inv.qc_status == 'verified' %}
                    <!-- Show verified QC details for this truck -->
                    <div class="row g-2 mb-2">
                      <div class="col-6">
                        <small class="text-muted d-block">Net Weight</small>
                        <strong>{{ inv.qc_weight or inv.qty }} Qt</strong>
                      </div>
                      <div class="col-6">
                        <small class="text-muted d-block">Moisture</small>
                        <strong>{{ inv.qc_moisture or '-' }}%</strong>
                      </div>
                    </div>
                    {% if inv.qc_remarks %}
                      <div class="mb-2">
                        <small class="text-muted d-block">Remarks</small>
                        <small>{{ inv.qc_remarks }}</small>
                      </div>
                    {% endif %}
                    {% if inv.qc_at %}
                      <small class="text-muted">Verified on {{ inv.qc_at[:16] }}</small>
                    {% endif %}
                  {% else %}
                    <!-- QC Form for this truck -->
                    <form method="POST" action="/miller/update_qc/{{ inv.id }}" class="mt-2">
                      <div class="row g-2 mb-2">
                        <div class="col-6">
                          <label class="form-label small mb-1">Net Weight (Qt)</label>
                          <input type="number"
                                 name="qc_weight"
                                 class="form-control form-control-sm"
                                 placeholder="Net Qt"
                                 value="{{ inv.qty }}"
                                 required>
                        </div>
                        <div class="col-6">
                          <label class="form-label small mb-1">Moisture (%)</label>
                          <input type="number"
                                 step="0.1"
                                 name="qc_moisture"
                                 class="form-control form-control-sm"
                                 placeholder="%"
                                 required>
                        </div>
                      </div>
                      <div class="mb-2">
                        <label class="form-label small mb-1">Remarks (Optional)</label>
                        <textarea name="qc_remarks"
                                  class="form-control form-control-sm"
                                  rows="2"
                                  placeholder="Quality notes, deductions, etc."></textarea>
                      </div>
                      <button class="btn btn-sm btn-success w-100">
                        <i class="fa fa-clipboard-check"></i> Save QC for This Truck
                      </button>
                    </form>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="border-top pt-3">
              <p class="text-muted small mb-0">No loading invoices yet.</p>
            </div>
          {% endif %}

          <!-- ================= UPLOAD FINAL INVOICE ================= -->
          {% set all_trucks_verified = true %}
          {% if invoices_map.get(booking_id) %}
            {% for inv in invoices_map[booking_id] %}
              {% if inv.qc_status != 'verified' %}
                {% set all_trucks_verified = false %}
              {% endif %}
            {% endfor %}
          {% else %}
            {% set all_trucks_verified = false %}
          {% endif %}

          {% if all_trucks_verified %}
            <div class="border-top mt-3 pt-3">
              <form method="POST"
                    action="/miller/upload_final_invoice/{{ booking_id }}"
                    enctype="multipart/form-data">

                <label class="form-label small fw-semibold mb-1">
                  <i class="fa fa-file-invoice"></i> Upload Final Invoice (Final Hisab)
                </label>

                <input type="file"
                       name="final_invoice"
                       class="form-control form-control-sm mb-2"
                       accept=".pdf,image/*"
                       required>

                <button class="btn btn-primary btn-sm w-100">
                  <i class="fa fa-upload"></i> Upload Final Invoice
                </button>
              </form>
            </div>
          {% else %}
            <div class="border-top mt-3 pt-3">
              <p class="text-muted small mb-0">
                <i class="fa fa-info-circle"></i> Complete all truck quality checks to upload final invoice.
              </p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
      {% endfor %}
    </div>
  </div>
  
  {% else %}
  <p class="text-muted">No completed loading orders yet.</p>
  {% endif %}
</div>

<!-- FINAL HISAB UPLOADED - PAYMENT PENDING -->
<div class="section-card" id="final-hisab">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h6 class="section-title mb-0">
      <i class="fa fa-file-invoice" style="color:#ffc107;"></i> Final Hisab Uploaded - Payment Pending
    </h6>
    <span class="badge bg-warning" id="finalInvoiceCount">{{ final_invoice_uploaded|length }} Orders</span>
  </div>

  {% if final_invoice_uploaded %}
  <div class="qc-scroll-container">
    <div class="row g-3">
      {% for b in final_invoice_uploaded %}
      {% set booking_id = b[0] %}
      {% set booked = b[3] %}
      {% set loaded = b[7] %}
      {% set order_id = b[10] %}
      {% set buyer_name = b[1] %}
      {% set crop_name = b[2] %}
      {% set payment_status = b[16] %}
      {% set final_invoice = b[17] %}
      {% set payment_at = b[18] %}

      <div class="col-md-6">
        <div class="card border-0 shadow-sm h-100 completed-loading-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <h6 class="mb-1"><strong class="text-primary">{{ b[10] }}</strong></h6>
                <p class="mb-1 text-muted small">{{ b[1] }} ‚Ä¢ <span class="text-capitalize">{{ b[2] }}</span></p>
                <div class="d-flex gap-2 mt-2">
                  <span class="badge bg-primary">{{ booked }} Qt Booked</span>
                  <span class="badge bg-success">{{ loaded }} Qt Loaded</span>
                </div>
              </div>
              <span class="badge bg-warning">üí∞ Payment Pending</span>
            </div>

            <!-- Final Invoice Info -->
            <div class="border-top pt-3">
              <div class="mb-3">
                <span class="badge bg-info mb-2">
                  <i class="fa fa-file-invoice"></i> Final Invoice Uploaded
                </span>
                {% if final_invoice %}
                  <a href="/static/uploads/bills/{{ final_invoice }}"
                     target="_blank"
                     class="btn btn-sm btn-outline-primary w-100 mt-2 mb-2">
                    <i class="fa fa-eye"></i> View Final Invoice
                  </a>
                  
                  <!-- Edit Final Invoice -->
                  <button class="btn btn-sm btn-warning w-100 mb-2"
                          data-bs-toggle="modal"
                          data-bs-target="#editFinalInvoice{{ booking_id }}">
                    <i class="fa fa-edit"></i> Edit/Replace Invoice
                  </button>
                  
                  <!-- Edit Modal -->
                  <div class="modal fade" id="editFinalInvoice{{ booking_id }}" tabindex="-1">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title">Edit Final Invoice</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <form method="POST"
                              action="/miller/edit_final_invoice/{{ booking_id }}"
                              enctype="multipart/form-data">
                          <div class="modal-body">
                            <div class="mb-3">
                              <label class="form-label">Upload New Invoice</label>
                              <input type="file"
                                     name="final_invoice"
                                     class="form-control"
                                     accept=".pdf,image/*"
                                     required>
                              <small class="text-muted">This will replace the existing invoice.</small>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-warning">
                              <i class="fa fa-upload"></i> Replace Invoice
                            </button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                {% endif %}
              </div>

              <!-- Mark Payment Done -->
              <form method="POST"
                    action="/miller/mark_payment_done/{{ booking_id }}">
                <button class="btn btn-success btn-sm w-100">
                  <i class="fa fa-check-circle"></i> Mark Payment Done
                </button>
              </form>
            </div>

            <!-- Per-Truck QC Summary -->
            {% if invoices_map.get(booking_id) %}
              <div class="border-top mt-3 pt-3">
                <small class="text-muted d-block mb-2 fw-semibold">
                  <i class="fa fa-truck"></i> Truck QC Summary:
                </small>
                {% for inv in invoices_map[booking_id] %}
                  <div class="mb-2 p-2 border rounded" style="background:#f8f9fa;">
                    <div class="d-flex justify-content-between">
                      <span><strong>Truck #{{ loop.index }}</strong> - {{ inv.qty }} Qt</span>
                      {% if inv.qc_status == 'verified' %}
                        <span class="badge bg-success">‚úÖ</span>
                      {% else %}
                        <span class="badge bg-warning">‚è≥</span>
                      {% endif %}
                    </div>
                    {% if inv.qc_status == 'verified' %}
                      <small class="text-muted">
                        Net: {{ inv.qc_weight or inv.qty }} Qt | 
                        Moisture: {{ inv.qc_moisture or '-' }}%
                      </small>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  
  {% else %}
  <p class="text-muted">No orders with final invoice uploaded yet.</p>
  {% endif %}
</div>

<!-- PAYMENT COMPLETED -->
{% if payment_completed %}
<div class="section-card">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h6 class="section-title mb-0">
      <i class="fa fa-check-circle" style="color:#198754;"></i> Payment Completed
    </h6>
    <span class="badge bg-success">{{ payment_completed|length }} Orders</span>
  </div>

  <div class="qc-scroll-container">
    <div class="row g-3">
      {% for b in payment_completed %}
      {% set booking_id = b[0] %}
      {% set booked = b[3] %}
      {% set loaded = b[7] %}
      {% set order_id = b[10] %}
      {% set buyer_name = b[1] %}
      {% set crop_name = b[2] %}
      {% set payment_status = b[16] %}
      {% set final_invoice = b[17] %}
      {% set payment_at = b[18] %}

      <div class="col-md-6">
        <div class="card border-0 shadow-sm h-100 completed-loading-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <h6 class="mb-1"><strong class="text-primary">{{ b[10] }}</strong></h6>
                <p class="mb-1 text-muted small">{{ b[1] }} ‚Ä¢ <span class="text-capitalize">{{ b[2] }}</span></p>
                <div class="d-flex gap-2 mt-2">
                  <span class="badge bg-primary">{{ booked }} Qt Booked</span>
                  <span class="badge bg-success">{{ loaded }} Qt Loaded</span>
                </div>
              </div>
              <span class="badge bg-success">‚úÖ Payment Completed</span>
            </div>

            <div class="border-top pt-3">
              {% if final_invoice %}
                <a href="/static/uploads/bills/{{ final_invoice }}"
                   target="_blank"
                   class="btn btn-sm btn-outline-primary w-100 mb-2">
                  <i class="fa fa-eye"></i> View Final Invoice
                </a>
                
                <!-- Edit Final Invoice -->
                <button class="btn btn-sm btn-warning w-100 mb-2"
                        data-bs-toggle="modal"
                        data-bs-target="#editFinalInvoicePaid{{ booking_id }}">
                  <i class="fa fa-edit"></i> Edit/Replace Invoice
                </button>
                
                <!-- Edit Modal -->
                <div class="modal fade" id="editFinalInvoicePaid{{ booking_id }}" tabindex="-1">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">Edit Final Invoice</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <form method="POST"
                            action="/miller/edit_final_invoice/{{ booking_id }}"
                            enctype="multipart/form-data">
                        <div class="modal-body">
                          <div class="mb-3">
                            <label class="form-label">Upload New Invoice</label>
                            <input type="file"
                                   name="final_invoice"
                                   class="form-control"
                                   accept=".pdf,image/*"
                                   required>
                            <small class="text-muted">This will replace the existing invoice.</small>
                          </div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <button type="submit" class="btn btn-warning">
                            <i class="fa fa-upload"></i> Replace Invoice
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              {% endif %}

              {% if payment_at %}
                <small class="text-muted d-block text-center">
                  Paid on {{ payment_at[:16] }}
                </small>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

<!-- REJECTED -->
<div class="section-card" id="rejected-orders">
  <h6 class="section-title">
    <i class="fa fa-times-circle" style="color:#8b6f47;"></i> Rejected Orders
  </h6>

  {% if rejected %}
<table class="table table-bordered">
  <tr>
    <th>Order ID</th>
    <th>Buyer</th>
    <th>Crop</th>
    <th>Qty</th>
    <th>Reason</th>
  </tr>

  {% for b in rejected %}
  <tr class="booking-row"
      data-status="declined"
      data-buyer="{{ b[1]|lower }}"
      data-crop="{{ b[2]|lower }}">

    <td><strong class="text-primary">{{ b[10] if b[10] else 'N/A' }}</strong></td>
    <td>{{ b[1] }}</td>
    <td>{{ b[2] }}</td>
    <td>
      <span class="badge bg-danger qty-badge">{{ b[3] }} Qt</span>
    </td>
    <td>{{ b[5] }}</td>
  </tr>
  {% endfor %}
</table>
{% else %}
<p class="text-muted">No rejected orders.</p>
{% endif %}

</div>
<!-- End of Rejected Orders Section -->

<script>
  function applyFilters() {
    const status = document.getElementById("statusFilter").value;
    const buyer = document.getElementById("buyerFilter").value.toLowerCase();
    const crop  = document.getElementById("cropFilter").value.toLowerCase();
  
    document.querySelectorAll(".booking-row").forEach(row => {
      const rowStatus = row.dataset.status;
      const rowBuyer  = row.dataset.buyer;
      const rowCrop   = row.dataset.crop;
  
      const matchStatus = (status === "all" || status === rowStatus);
      const matchBuyer  = rowBuyer.includes(buyer);
      const matchCrop   = rowCrop.includes(crop);
  
      if (matchStatus && matchBuyer && matchCrop) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    });
  }
  
  function clearFilters() {
    document.getElementById("statusFilter").value = "all";
    document.getElementById("buyerFilter").value = "";
    document.getElementById("cropFilter").value = "";
    applyFilters();
  }
  
  document.getElementById("statusFilter").addEventListener("change", applyFilters);
  document.getElementById("buyerFilter").addEventListener("keyup", applyFilters);
  document.getElementById("cropFilter").addEventListener("keyup", applyFilters);

  window.onload = applyFilters;

  // QC Filter & Search Functions
  let currentQCFilter = 'all';
  
  function filterQC(status) {
    currentQCFilter = status;
    
    // Update button states
    document.querySelectorAll('.qc-filter-btn').forEach(btn => {
      btn.classList.remove('active');
      if(btn.dataset.filter === status) {
        btn.classList.add('active');
      }
    });
    
    // Apply filter
    applyQCFilter();
  }
  
  function searchQC() {
    applyQCFilter();
  }
  
  function applyQCFilter() {
    const searchTerm = document.getElementById('qcSearchInput')?.value.toLowerCase() || '';
    const cards = document.querySelectorAll('.qc-card-item');
    let visibleCount = 0;
    
    cards.forEach(card => {
      const searchText = card.dataset.search || '';
      
      // Check if this card has any pending trucks
      const pendingBadges = card.querySelectorAll('.badge.bg-warning');
      const verifiedBadges = card.querySelectorAll('.badge.bg-success');
      const hasPending = pendingBadges.length > 0;
      const allVerified = verifiedBadges.length > 0 && pendingBadges.length === 0;
      
      // Status filter - check per-truck status
      let statusMatch = true;
      if (currentQCFilter === 'pending') {
        statusMatch = hasPending;
      } else if (currentQCFilter === 'verified') {
        statusMatch = allVerified && verifiedBadges.length > 0;
      }
      
      // Search filter
      const searchMatch = !searchTerm || searchText.includes(searchTerm);
      
      if (statusMatch && searchMatch) {
        card.style.display = '';
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    });
    
    // Update count badge
    const countBadge = document.getElementById('qcCount');
    if(countBadge) {
      countBadge.textContent = `${visibleCount} Orders`;
    }
  }
  
  // Initialize QC search on page load
  const qcSearchInput = document.getElementById('qcSearchInput');
  if(qcSearchInput) {
    qcSearchInput.addEventListener('input', searchQC);
  }

 
  </script>
  
</div> <!-- container -->
</main> <!-- flex-fill -->

<!-- ================= FOOTER ================= -->
<footer class="footer">
  <div class="container">
    <div class="row g-4">
      <!-- BRAND -->
      <div class="col-md-4">
        <h5 class="fw-bold text-white mb-2">
          <i class="fa fa-industry"></i> Sarna Mandi - Miller
        </h5>
        <p class="small">
          Digital mandi platform for <b>millers</b> to manage stock,
          approve orders, and process payments with transparency and efficiency.
        </p>
      </div>

      <!-- QUICK LINKS -->
      <div class="col-md-4">
        <h6 class="fw-bold text-white mb-2">Quick Links</h6>
        <ul class="list-unstyled small">
          <li><a href="#approved-loading">Approved Orders</a></li>
          <li><a href="#quality-check">Quality Check</a></li>
          <li><a href="#final-hisab">Final Hisab</a></li>
          <li><a href="#rejected-orders">Rejected Orders</a></li>
          <li><a href="/miller/profile">Profile</a></li>
        </ul>
      </div>

      <!-- CONTACT -->
      <div class="col-md-4">
        <h6 class="fw-bold text-white mb-2">Contact</h6>
        <p class="small mb-1">
          <i class="fa fa-phone me-2"></i> +91 XXXXX XXXXX
        </p>
        <p class="small mb-1">
          <i class="fa fa-envelope me-2"></i> support@sarnamandi.com
        </p>
        <p class="small">
          <i class="fa fa-location-dot me-2"></i> India
        </p>

        <!-- SOCIAL -->
        <div class="mt-2">
          <a href="#" class="footer-icon"><i class="fab fa-linkedin"></i></a>
          <a href="#" class="footer-icon"><i class="fab fa-whatsapp"></i></a>
          <a href="#" class="footer-icon"><i class="fab fa-twitter"></i></a>
        </div>
      </div>
    </div>

    <!-- BOTTOM -->
    <div class="footer-bottom text-center mt-4 pt-3">
      ¬© 2026 <b>Sarna Mandi</b> ¬∑ All Rights Reserved
    </div>
  </div>
</footer>

</div> <!-- flex container -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Market | Sarna Broker</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #1e6f5c;
    --primary-dark: #145a48;
    --bg: #f4f7f6;
    --card: #ffffff;
    --text: #2c3e50;
    --muted: #7f8c8d;
    --border: #e5e9ec;
    --success: #198754;
    --warning: #ffc107;
    --danger: #dc3545;
    --info: #0dcaf0;
    --radius: 14px;
  }

  /* ---------- GLOBAL ---------- */
  body {
    background: var(--bg);
    font-family: 'Inter', 'Segoe UI', sans-serif;
    color: var(--text);
    font-weight: 400;
    line-height: 1.6;
  }

  .app-shell {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* ---------- NAVBAR ---------- */
  .navbar {
    border-radius: var(--radius);
    margin: 16px;
    box-shadow: 0 10px 28px rgba(0,0,0,.08);
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  }

  .navbar-brand {
    font-weight: 800;
    font-size: 1.25rem;
  }

  /* ---------- MARKET FRAME ---------- */
  .market-frame {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .data-scroll {
    flex: 1;
    overflow-y: auto;
    padding: 0 16px 80px 16px;
    scrollbar-width: thin;
    scrollbar-color: #c1c1c1 transparent;
  }

  .data-scroll::-webkit-scrollbar {
    width: 6px;
  }

  .data-scroll::-webkit-scrollbar-track {
    background: transparent;
  }

  .data-scroll::-webkit-scrollbar-thumb {
    background-color: #c1c1c1;
    border-radius: 20px;
  }

  /* ---------- SECTION TITLES ---------- */
  .section-title {
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 1.25rem;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .section-title i {
    color: var(--primary);
  }

  /* ---------- CARD STYLES ---------- */
  .card-box {
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: 0 8px 24px rgba(0,0,0,.06);
    border: 1px solid var(--border);
    padding: 1.25rem;
  }

  .market-card {
    background: white;
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: 0 6px 20px rgba(0,0,0,.06);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: 1px solid var(--border);
  }

  .market-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 28px rgba(0,0,0,.1);
  }

  .market-img-real {
    width: 100%;
    height: 180px;
    object-fit: cover;
  }

  .market-body {
    padding: 1rem;
  }

  /* ---------- TABLE STYLES ---------- */
  .table-responsive {
    border-radius: var(--radius);
    overflow: hidden;
    border: 1px solid var(--border);
  }

  .table {
    margin-bottom: 0;
    font-family: 'Inter', sans-serif;
    font-size: 0.9rem;
  }

  .table thead th {
    background-color: #f8f9fa;
    border: none;
    font-weight: 700;
    font-size: 0.75rem;
    text-transform: uppercase;
    color: var(--muted);
    padding: 1rem 0.75rem;
    white-space: nowrap;
  }

  .table tbody tr {
    transition: background-color 0.2s ease;
  }

  .table tbody tr:hover {
    background-color: #f8fafb;
  }

  .table tbody td {
    border: none;
    padding: 1rem 0.75rem;
    vertical-align: middle;
    font-weight: 500;
    border-top: 1px solid var(--border);
  }

  .table-striped tbody tr:nth-of-type(odd) {
    background-color: rgba(0,0,0,.02);
  }

  /* ---------- BADGES ---------- */
  .badge {
    font-weight: 600;
    padding: 0.4em 0.8em;
    border-radius: 20px;
    font-size: 0.75rem;
  }

  .badge.bg-success {
    background-color: #d1e7dd !important;
    color: #0f5132 !important;
  }

  .badge.bg-secondary {
    background-color: #e2e3e5 !important;
    color: #383d41 !important;
  }

  .badge.bg-danger {
    background-color: #f8d7da !important;
    color: #842029 !important;
  }

  .badge.bg-info {
    background-color: #cff4fc !important;
    color: #055160 !important;
  }

  /* ---------- ORDER STATUS ---------- */
  .order-status {
    padding: 6px 14px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.75rem;
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    gap: 5px;
  }

  .status-approved { background: #e7f0ff; color: #0d6efd; }
  .status-active { background: #fff3cd; color: #856404; }
  .status-loaded { background: #e9f7ef; color: #157347; }
  .status-partial { background: #fdecea; color: #842029; }
  .status-paid { background: #d4edda; color: #155724; }

  /* ---------- ORDER CARDS ---------- */
  .order-card {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 1rem;
    overflow: hidden;
    box-shadow: 0 6px 18px rgba(0,0,0,.06);
    transition: all 0.2s ease;
  }

  .order-card:hover {
    box-shadow: 0 10px 28px rgba(0,0,0,.08);
  }

  .order-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.25rem;
  }

  .order-main {
    flex: 1;
  }

  .order-id {
    font-size: 1.1rem;
    font-weight: 800;
    color: var(--primary);
    display: block;
    margin-bottom: 0.25rem;
  }

  .order-crop {
    font-weight: 700;
    color: var(--text);
    font-size: 0.95rem;
  }

  .order-meta-row {
    display: flex;
    gap: 1rem;
    margin-top: 0.5rem;
    font-size: 0.8rem;
    color: var(--muted);
  }

  .order-meta-row span {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .order-expand {
    color: var(--muted);
    transition: transform 0.3s ease;
  }

  .accordion-button:not(.collapsed) .order-expand {
    transform: rotate(180deg);
  }

  /* ---------- ACCORDION BODY ---------- */
  .accordion-body {
    padding: 1.25rem;
    background-color: #f8fafb;
  }

  .order-body-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  @media (min-width: 768px) {
    .order-body-grid {
      grid-template-columns: 1fr 1fr;
    }
  }

  .soft-card {
    background: white;
    border-radius: calc(var(--radius) - 4px);
    padding: 1rem;
    border: 1px solid var(--border);
  }

  .kv {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f1f3f5;
  }

  .kv:last-child {
    border-bottom: none;
  }

  .kv span:first-child {
    color: var(--muted);
    font-weight: 500;
    font-size: 0.9rem;
  }

  .kv span:last-child {
    font-weight: 600;
    color: var(--text);
  }

  /* ---------- BUTTONS ---------- */
  .btn {
    border-radius: 10px;
    font-weight: 600;
    padding: 0.5rem 1rem;
    transition: all 0.2s ease;
  }

  .btn-primary {
    background: var(--primary);
    border: none;
  }

  .btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
  }

  .btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
  }

  /* ---------- PROGRESS BAR ---------- */
  .progress {
    height: 8px;
    border-radius: 10px;
    background-color: #e9ecef;
  }

  .progress-bar {
    border-radius: 10px;
    transition: width 0.6s ease;
  }

  /* ---------- SEARCH & FILTERS ---------- */
  .orders-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .search {
    flex: 1;
    min-width: 250px;
  }

  .search input {
    border-radius: 10px;
    border: 1px solid var(--border);
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
  }

  .pill {
    background: #e9ecef;
    color: var(--text);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.9rem;
  }
  /* FOOTER */
.footer{
  background:#0b1c2d;
  color:#cfd6df;
  padding:40px 0 20px;
  margin-top:auto;
}

.footer-bottom{
  border-top:1px solid rgba(255,255,255,.1);
  margin-top:20px;
  padding-top:15px;
  font-size:.85rem;
  text-align:center;
}
  /* ---------- MODAL STYLES ---------- */
  .modal-content {
    border-radius: var(--radius);
    border: none;
    box-shadow: 0 20px 40px rgba(0,0,0,.15);
  }

  /* ---------- RESPONSIVE ---------- */
  @media (max-width: 768px) {
    .data-scroll {
      padding: 0 12px 60px 12px;
    }
    
    .navbar {
      margin: 12px;
    }
    
    .table-responsive {
      font-size: 0.85rem;
    }
    
    .order-card-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }
    
    .order-meta-row {
      flex-wrap: wrap;
    }
    
    .orders-toolbar {
      flex-direction: column;
      align-items: stretch;
    }
    
    .search {
      min-width: 100%;
    }
  }

  /* ---------- UTILITY ---------- */
  .text-muted {
    color: var(--muted) !important;
  }

  .fw-bold {
    font-weight: 700 !important;
  }

  .fw-800 {
    font-weight: 800 !important;
  }
</style>
</head>

<body class="bg-light">
<div class="app-shell">
<!-- NAVBAR -->

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark sticky-top">
  <div class="container">
    <a class="navbar-brand" href="/market">
      <i class="fa fa-seedling"></i> Sarna Mandi
    </a>
    <div class="collapse navbar-collapse show">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link active" href="/buyer/active">Active</a></li>
        <li class="nav-item"><a class="nav-link" href="/buyer/partial">Partial closed</a></li>
        <li class="nav-item"><a class="nav-link" href="/buyer/loaded">Loaded</a></li>
        <li class="nav-item"><a class="nav-link" href="/buyer/payments">Payments</a></li>
        <li class="nav-item"><a class="nav-link" href="/buyer/profile">Profile</a></li>
        <li class="nav-item"><a class="nav-link" href="/logout">Logout</a></li>
      </ul>
    </div>
  </div>
</nav>


  <!-- MAIN CONTENT -->
  <div class="market-frame">
    <div class="data-scroll">
       <!-- ================= MILLER STOCKS ================= -->
      <div class="container mt-5">
        <h5 class="section-title">
          <i class="fa fa-industry"></i> Miller Stocks (Live)
        </h5>
        
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Miller</th>
                <th>Crop</th>
                <th>Qty (Qt)</th>
                <th>Price</th>
                <th>Condition</th>
                <th>Bag</th>
                <th>Deduction</th>
                <th>Action</th>
              </tr>
            </thead>
            
            <tbody>
              {% for m in miller_stocks %}
              <tr>
                <td class="fw-600">
                  <i class="fa fa-industry text-success me-2"></i>
                  {{ m[10] }}
                </td>
                <td>{{ m[2] }}</td>
                
                <td>
                  {% if m[3] > 0 %}
                    <span class="badge bg-secondary">{{ m[3] }} Qt</span>
                  {% else %}
                    <span class="badge bg-danger">Sold Out</span>
                  {% endif %}
                </td>
                
                <td class="fw-bold text-success">₹{{ m[4] }}</td>
                <td><span class="badge bg-info">{{ m[5] }}</span></td>
                <td>{{ m[6] }}</td>
                <td>₹{{ m[7] }}</td>
                
                <td style="min-width: 160px;">
                  {% if m[3] > 0 %}
                  <form method="POST" action="/book_miller_stock/{{ m[0] }}">
                    <input type="number" 
                           name="quantity" 
                           min="1" 
                           max="{{ m[3] }}"
                           class="form-control form-control-sm mb-2" 
                           placeholder="Qty" 
                           required>
                    <button type="submit" class="btn btn-success btn-sm w-100">
                      <i class="fa fa-shopping-cart me-1"></i> Book
                    </button>
                  </form>
                  {% else %}
                    <span class="text-muted small">Unavailable</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- ================= ACTIVE ORDERS ================= -->
      {% if my_bookings %}
      <div class="container mt-5">
        <h5 class="section-title">
          <i class="fa fa-clock"></i> Active Orders
          <span class="pill ms-3">{{ my_bookings|length }} Active</span>
        </h5>
        
        <!-- Summary Stats -->
        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <div class="card border-primary shadow-sm">
              <div class="card-body text-center py-3">
                <h6 class="text-muted mb-2 small">
                  <i class="fa fa-shopping-cart me-1"></i> Total Booked
                </h6>
                <h4 class="text-primary mb-0 fw-bold">{{ total_booked }} Qt</h4>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-success shadow-sm">
              <div class="card-body text-center py-3">
                <h6 class="text-muted mb-2 small">
                  <i class="fa fa-check-circle me-1"></i> Total Loaded
                </h6>
                <h4 class="text-success mb-0 fw-bold">{{ total_loaded }} Qt</h4>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-warning shadow-sm">
              <div class="card-body text-center py-3">
                <h6 class="text-muted mb-2 small">
                  <i class="fa fa-clock me-1"></i> Total Remaining
                </h6>
                <h4 class="text-warning mb-0 fw-bold">{{ total_remaining }} Qt</h4>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Search Bar -->
        <div class="orders-toolbar">
          <div class="search">
            <input type="text" 
                   id="orderSearch" 
                   class="form-control" 
                   placeholder="Search by Order ID or Crop...">
          </div>
        </div>
        
        <!-- Orders Accordion -->
        <div class="accordion" id="ordersAccordion">
          {% for b in my_bookings %}
          {% set order_id = b[9] if b[9] else 'N/A' %}
          {% set crop = b[1] %}
          {% set booked_qty = b[2] or 0 %}
          {% set loaded_qty = b[3] or 0 %}
          {% set remaining_qty = b[4] or 0 %}
          {% set loading_status = b[8] %}
          {% set bill_status = b[7] %}
          {% set booking_status = b[10] if b[10] else 'pending' %}
          {% set payment_status = b[17] %}
          {% set final_invoice = b[18] %}
          {% set payment_at = b[19] %}
          {% set progress = ((loaded_qty / booked_qty) * 100) | round if booked_qty > 0 else 0 %}
          
          <div class="order-card" data-search="{{ order_id|lower }} {{ crop|lower }}">
            <div class="accordion-item border-0">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#collapse{{ loop.index }}">
                  <div class="order-card-header">
                    <div class="order-main">
                      <span class="order-id">{{ order_id }}</span>
                      <span class="order-crop">{{ crop }}</span>
                      
                      <div class="order-meta-row">
                        <span><i class="fa fa-box"></i> {{ booked_qty }} Qt Booked</span>
                        <span><i class="fa fa-truck"></i> {{ loaded_qty }} Qt Loaded</span>
                        <span><i class="fa fa-hourglass-half"></i> {{ remaining_qty }} Qt Remaining</span>
                      </div>
                    </div>
                    
                    <div class="d-flex align-items-center gap-3">
                      {% if payment_status == 'paid' %}
                        <span class="order-status status-paid">
                          <i class="fa fa-circle-check"></i> Paid
                        </span>
                      {% elif loading_status == 'loaded' %}
                        <span class="order-status status-active">
                          <i class="fa fa-hourglass-half"></i> Payment Pending
                        </span>
                      {% else %}
                        <span class="order-status status-active">
                          <i class="fa fa-truck"></i> Active
                        </span>
                      {% endif %}
                      
                      <i class="fa fa-chevron-down order-expand"></i>
                    </div>
                  </div>
                </button>
              </h2>
              
              <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" 
                   data-bs-parent="#ordersAccordion">
                <div class="accordion-body">
                  <div class="order-body-grid">
                    
                    <!-- Left Column: Order Details -->
                    <div class="soft-card">
                      <div class="kv">
                        <span>Booked Quantity</span>
                        <span>{{ booked_qty }} Qt</span>
                      </div>
                      <div class="kv">
                        <span>Loaded Quantity</span>
                        <span>{{ loaded_qty }} Qt</span>
                      </div>
                      <div class="kv">
                        <span>Remaining Quantity</span>
                        <span>{{ remaining_qty }} Qt</span>
                      </div>
                      <div class="kv">
                        <span>Status</span>
                        <span>
                          {% if loading_status == 'pending' %}
                            Waiting for Truck
                          {% elif loading_status == 'partial_closed' %}
                            Closed by Buyer (Partial)
                          {% elif loading_status == 'loaded' %}
                            Fully Loaded
                          {% elif loading_status == 'rejected' %}
                            Rejected
                          {% endif %}
                        </span>
                      </div>
                      <div class="kv">
                        <span>Progress</span>
                        <div class="d-flex flex-column w-100">
                          <div class="progress mb-1">
                            <div class="progress-bar bg-success" 
                                 style="width: {{ progress }}%"></div>
                          </div>
                          <small class="text-muted">{{ progress }}% Loaded</small>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Right Column: Actions -->
                    <div class="soft-card">
                      {% if booking_status == 'approved' and remaining_qty > 0 and loading_status != 'partial_closed' %}
                      <!-- Close Remaining Button -->
                      <button class="btn btn-warning btn-sm w-100 mb-3" 
                              data-bs-toggle="modal" 
                              data-bs-target="#closeRemainingModal{{ b[0] }}">
                        <i class="fa fa-lock me-1"></i> Close Remaining Qty
                      </button>
                      
                      <!-- Upload Loading Form -->
                      <form method="POST" action="/buyer/update_loading/{{ b[0] }}" 
                            enctype="multipart/form-data">
                        <div class="mb-3">
                          <label class="form-label small fw-bold">Quantity to Load</label>
                          <input type="number" 
                                 name="load_qty" 
                                 min="1" 
                                 max="{{ remaining_qty }}"
                                 class="form-control" 
                                 placeholder="Qty to load" 
                                 required>
                        </div>
                        
                        <div class="mb-3">
                          <label class="form-label small fw-bold">Upload Invoice</label>
                          <input type="file" 
                                 name="invoice" 
                                 accept="image/*,.pdf"
                                 class="form-control" 
                                 required>
                        </div>
                        
                        <button type="submit" class="btn btn-success btn-sm w-100">
                          <i class="fa fa-truck me-1"></i> Upload & Update Loading
                        </button>
                      </form>
                      {% endif %}
                      
                      <!-- Payment Info -->
                      <div class="mt-4">
                        {% if payment_status == 'paid' and final_invoice %}
                          <a href="/static/uploads/bills/{{ final_invoice }}" 
                             target="_blank"
                             class="btn btn-primary btn-sm w-100 mb-2">
                            <i class="fa fa-file-invoice me-1"></i> View Final Invoice
                          </a>
                          
                          {% if payment_at %}
                            <small class="text-muted d-block text-center">
                              <i class="fa fa-clock me-1"></i>
                              Paid on {{ payment_at[:16] }}
                            </small>
                          {% endif %}
                        {% elif loading_status == 'loaded' %}
                          <p class="text-muted small text-center">
                            Payment pending from miller
                          </p>
                        {% endif %}
                      </div>
                    </div>
                    
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- ================= PARTIALLY CLOSED ORDERS ================= -->
      {% if partial_closed_bookings %}
      <div class="container mt-5">
        <h5 class="section-title text-warning">
          <i class="fa fa-lock"></i> Partially Closed Orders
          <span class="pill ms-3">{{ partial_closed_bookings|length }} Orders</span>
        </h5>
        
        <div class="accordion" id="partialClosedAccordion">
          {% for b in partial_closed_bookings %}
          {% set order_id = b[9] %}
          {% set crop = b[1] %}
          {% set booked_qty = b[2] or 0 %}
          {% set loaded_qty = b[3] or 0 %}
          {% set remaining_qty = b[4] or 0 %}
          
          <div class="order-card">
            <div class="accordion-item border-0">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#pc{{ b[0] }}">
                  <div class="order-card-header">
                    <div class="order-main">
                      <span class="order-id">{{ order_id }}</span>
                      <span class="order-crop">{{ crop }}</span>
                      
                      <div class="order-meta-row">
                        <span><i class="fa fa-box"></i> {{ booked_qty }} Qt Booked</span>
                        <span><i class="fa fa-check"></i> {{ loaded_qty }} Qt Loaded</span>
                      </div>
                    </div>
                    
                    <div class="d-flex align-items-center gap-3">
                      <span class="order-status status-partial">
                        <i class="fa fa-lock"></i> Partially Closed
                      </span>
                      <i class="fa fa-chevron-down order-expand"></i>
                    </div>
                  </div>
                </button>
              </h2>
              
              <div id="pc{{ b[0] }}" class="accordion-collapse collapse" 
                   data-bs-parent="#partialClosedAccordion">
                <div class="accordion-body">
                  <div class="order-body-grid">
                    
                    <!-- Order Details -->
                    <div class="soft-card">
                      <div class="kv">
                        <span>Booked Quantity</span>
                        <span>{{ booked_qty }} Qt</span>
                      </div>
                      <div class="kv">
                        <span>Loaded Quantity</span>
                        <span>{{ loaded_qty }} Qt</span>
                      </div>
                      <div class="kv">
                        <span>Closed Quantity</span>
                        <span>{{ remaining_qty }} Qt</span>
                      </div>
                      
                      {% if b[11] %}
                      <div class="kv">
                        <span>Reason for Closure</span>
                        <span class="text-muted">{{ b[11] }}</span>
                      </div>
                      {% endif %}
                    </div>
                    
                    <!-- Mill Details -->
                    <div class="soft-card">
                      <div class="mb-3">
                        <h6 class="fw-bold">
                          <i class="fa fa-balance-scale me-1"></i> Final Mill Details
                        </h6>
                      </div>
                      
                      {% if b[14] == 'verified' %}
                        <div class="kv">
                          <span>Final Weight</span>
                          <span>{{ b[11] or loaded_qty }} Qt</span>
                        </div>
                        <div class="kv">
                          <span>Moisture</span>
                          <span>{{ b[12] }}%</span>
                        </div>
                        
                        {% if b[13] %}
                        <div class="kv">
                          <span>Remarks</span>
                          <span>{{ b[13] }}</span>
                        </div>
                        {% endif %}
                        
                        {% if b[15] %}
                        <small class="text-muted d-block mt-3">
                          Verified on {{ b[15][:16] }}
                        </small>
                        {% endif %}
                      {% else %}
                        <p class="text-muted small">
                          Waiting for miller quality verification.
                        </p>
                      {% endif %}
                    </div>
                    
                  </div>
                  
                  <!-- Loading Invoices -->
                  <div class="soft-card mt-3">
                    <h6 class="fw-bold mb-3">
                      <i class="fa fa-file-invoice me-1"></i> Loading Invoices
                    </h6>
                    
                    {% set invs = invoices_map.get(b[0]) %}
                    {% if invs %}
                      <div class="list-group">
                        {% for inv in invs %}
                          <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                              <strong>{{ inv.qty }} Qt</strong>
                              <br>
                              <small class="text-muted">{{ inv.date[:16] if inv.date else '' }}</small>
                            </div>
                            <a href="/static/uploads/bills/{{ inv.file }}" 
                               target="_blank"
                               class="btn btn-sm btn-outline-primary">
                              <i class="fa fa-eye me-1"></i> View
                            </a>
                          </div>
                        {% endfor %}
                      </div>
                    {% else %}
                      <p class="text-muted small mb-0">No invoices uploaded.</p>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- ================= LOADED ORDERS ================= -->
      {% if loaded_bookings %}
      <div class="container mt-5 mb-5">
        <h5 class="section-title text-success">
          <i class="fa fa-check-circle"></i> Loaded Orders
          <span class="pill ms-3">{{ loaded_bookings|length }} Loaded</span>
        </h5>
        
        <!-- Search Bar -->
        <div class="orders-toolbar">
          <div class="search">
            <input type="text" 
                   id="loadedSearch" 
                   class="form-control" 
                   placeholder="Search loaded orders...">
          </div>
        </div>
        
        <div class="accordion" id="loadedAccordion">
          {% for b in loaded_bookings %}
          {% set order_id = b[9] if b[9] else 'N/A' %}
          {% set crop = b[1] %}
          {% set booked_qty = b[2] or 0 %}
          {% set loaded_qty = b[3] or 0 %}
          {% set loaded_date = b[6] %}
          {% set bill_file = b[7] %}
          {% set qc_weight = b[11] %}
          {% set qc_moisture = b[12] %}
          {% set qc_remarks = b[13] %}
          {% set qc_status = b[14] %}
          {% set qc_at = b[15] %}
          
          <div class="order-card" data-search="{{ order_id|lower }} {{ crop|lower }}">
            <div class="accordion-item border-0">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#loaded{{ loop.index }}">
                  <div class="order-card-header">
                    <div class="order-main">
                      <span class="order-id">{{ order_id }}</span>
                      <span class="order-crop">{{ crop }}</span>
                      
                      <div class="order-meta-row">
                        <span><i class="fa fa-box"></i> {{ booked_qty }} Qt Booked</span>
                        <span><i class="fa fa-check"></i> {{ loaded_qty }} Qt Loaded</span>
                        {% if loaded_date %}
                        <span><i class="fa fa-calendar"></i> {{ loaded_date[:10] }}</span>
                        {% endif %}
                      </div>
                    </div>
                    
                    <div class="d-flex align-items-center gap-3">
                      <span class="order-status status-loaded">
                        <i class="fa fa-check-circle"></i> Loaded
                      </span>
                      <i class="fa fa-chevron-down order-expand"></i>
                    </div>
                  </div>
                </button>
              </h2>
              
              <div id="loaded{{ loop.index }}" class="accordion-collapse collapse" 
                   data-bs-parent="#loadedAccordion">
                <div class="accordion-body">
                  <div class="order-body-grid">
                    
                    <!-- Order Details -->
                    <div class="soft-card">
                      <div class="kv">
                        <span>Booked Quantity</span>
                        <span>{{ booked_qty }} Qt</span>
                      </div>
                      <div class="kv">
                        <span>Loaded Quantity</span>
                        <span>{{ loaded_qty }} Qt</span>
                      </div>
                      <div class="kv">
                        <span>Loaded Date</span>
                        <span>{{ loaded_date[:16] if loaded_date else '—' }}</span>
                      </div>
                      <div class="kv">
                        <span>QC Status</span>
                        <span>
                          {% if qc_status == 'verified' %}
                            ✅ Verified by miller
                          {% else %}
                            ⏳ Pending at miller
                          {% endif %}
                        </span>
                      </div>
                    </div>
                    
                    <!-- Mill Details -->
                    <div class="soft-card">
                      <h6 class="fw-bold mb-3">
                        <i class="fa fa-balance-scale me-1"></i> Final Mill Details
                      </h6>
                      
                      {% if qc_status == 'verified' %}
                        <div class="kv">
                          <span>Net Weight</span>
                          <span>{{ qc_weight or loaded_qty }} Qt</span>
                        </div>
                        <div class="kv">
                          <span>Moisture</span>
                          <span>{{ qc_moisture or '-' }}%</span>
                        </div>
                        
                        {% if qc_remarks %}
                        <div class="kv">
                          <span>Remarks</span>
                          <span>{{ qc_remarks }}</span>
                        </div>
                        {% endif %}
                        
                        {% if qc_at %}
                        <small class="text-muted d-block mt-3">
                          Verified on {{ qc_at[:16] }}
                        </small>
                        {% endif %}
                      {% else %}
                        <p class="text-muted small mb-0">
                          Waiting for miller to verify weight & moisture.
                        </p>
                      {% endif %}
                    </div>
                  </div>
                  
                  <!-- Loading Invoices -->
                  <div class="soft-card mt-3">
                    <h6 class="fw-bold mb-3">
                      <i class="fa fa-file-invoice me-1"></i> Loading Invoices
                    </h6>
                    
                    {% set invs = invoices_map.get(b[0]) if invoices_map else None %}
                    {% if invs %}
                      <div class="list-group">
                        {% for inv in invs %}
                          <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                              <strong>{{ inv.qty }} Qt</strong>
                              <br>
                              <small class="text-muted">{{ inv.date[:16] if inv.date else '' }}</small>
                            </div>
                            <a href="/static/uploads/bills/{{ inv.file }}" 
                               target="_blank"
                               class="btn btn-sm btn-outline-primary">
                              <i class="fa fa-eye me-1"></i> View Invoice
                            </a>
                          </div>
                        {% endfor %}
                      </div>
                    {% else %}
                      <p class="text-muted small mb-0">No loading invoices found.</p>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
      
    </div> <!-- data-scroll -->
  </div> <!-- market-frame -->
</div> <!-- app-shell -->
<!-- FOOTER -->
<!-- ================= ENHANCED FOOTER ================= -->
<footer class="footer mt-5">
  <div class="container">

    <div class="row g-4">

      <!-- BRAND -->
      <div class="col-md-4">
        <h5 class="fw-bold text-white mb-2">
          <i class="fa fa-seedling"></i> Sarna Mandi
        </h5>
        <p class="small">
          Digital mandi platform connecting
          <b>farmers, traders and millers</b>
          with transparency, trust and speed.
        </p>
      </div>

      <!-- QUICK LINKS -->
      <div class="col-md-4">
        <h6 class="fw-bold text-white mb-2">Trader Pages</h6>
        <ul class="list-unstyled small">
          <li><a href="/market">Market</a></li>
          <li><a href="/buyer/active">Active Orders</a></li>
          <li><a href="/buyer/partial">Partially Closed</a></li>
          <li><a href="/buyer/loaded">Loaded Orders</a></li>
          <li><a href="/buyer/payments">Payments</a></li>
        </ul>
      </div>

      <!-- CONTACT -->
      <div class="col-md-4">
        <h6 class="fw-bold text-white mb-2">Contact</h6>
        <p class="small mb-1">
          <i class="fa fa-phone me-2"></i> +91 XXXXX XXXXX
        </p>
        <p class="small mb-1">
          <i class="fa fa-envelope me-2"></i> support@sarnamandi.com
        </p>
        <p class="small">
          <i class="fa fa-location-dot me-2"></i> India
        </p>

        <!-- SOCIAL -->
        <div class="mt-2">
          <a href="#" class="footer-icon"><i class="fab fa-linkedin"></i></a>
          <a href="#" class="footer-icon"><i class="fab fa-whatsapp"></i></a>
          <a href="#" class="footer-icon"><i class="fab fa-twitter"></i></a>
        </div>
      </div>

    </div>

    <!-- BOTTOM -->
    <div class="footer-bottom text-center mt-4 pt-3">
      © 2026 <b>Sarna Mandi</b> · All Rights Reserved
    </div>

  </div>
</footer>

<!-- JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Search functionality for active orders
  const orderSearchInput = document.getElementById('orderSearch');
  if (orderSearchInput) {
    orderSearchInput.addEventListener('input', function() {
      const term = this.value.toLowerCase().trim();
      document.querySelectorAll('#ordersAccordion .order-card').forEach(card => {
        const searchText = card.dataset.search || '';
        card.style.display = searchText.includes(term) ? '' : 'none';
      });
    });
  }

  // Search functionality for loaded orders
  const loadedSearchInput = document.getElementById('loadedSearch');
  if (loadedSearchInput) {
    loadedSearchInput.addEventListener('input', function() {
      const term = this.value.toLowerCase().trim();
      document.querySelectorAll('#loadedAccordion .order-card').forEach(card => {
        const searchText = card.dataset.search || '';
        card.style.display = searchText.includes(term) ? '' : 'none';
      });
    });
  }

  // Initialize progress bars
  document.querySelectorAll('.progress-bar').forEach(bar => {
    const width = bar.style.width;
    bar.style.width = '0';
    setTimeout(() => {
      bar.style.width = width;
    }, 100);
  });
</script>
</body>
</html>